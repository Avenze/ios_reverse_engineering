---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2023/10/18 16:33
---

--local Class = require("Framework.Lua.Class")
---@class PowerManager
local PowerManager = GameTableDefine.PowerManager
local CountryMode = GameTableDefine.CountryMode
local ConfigMgr = GameTableDefine.ConfigMgr
local GreatBuildingMana = GameTableDefine.GreateBuildingMana
local EventManager = require("Framework.Event.Manager")

function PowerManager:ctor()
    self.m_powerUsed = 0
    self.m_totalPower = 0
end

---计算消耗电量
function PowerManager:CalculatePowerUsed()
    local power = 0,0
    local localData = LocalDataManager:GetDataByKey(CountryMode.rooms)
    local furnitureCfg = ConfigMgr.config_furnitures_levels
    for roomIndex,roomData in pairs(localData or {}) do
        for furnitureIndex,furnitureData in pairs(roomData.furnitures or{}) do
            local furnitureId = furnitureData.id

            local currCgf = furnitureCfg[furnitureId] or {}

            local currLevelCfg = currCgf[furnitureData.level or 0]
            if currLevelCfg and currLevelCfg.power_consume and currLevelCfg.power_consume < 0 then
                power = power + currLevelCfg.power_consume
            end
        end
    end

    power = - power

    if self.m_powerUsed ~= power then
        self.m_powerUsed = power
    end
end

---计算总电量
function PowerManager:CalculateTotalPower()
    local power = 0
    local localData = LocalDataManager:GetDataByKey(CountryMode.rooms)
    local furnitureCfg = ConfigMgr.config_furnitures_levels
    for roomIndex,roomData in pairs(localData or {}) do
        for furnitureIndex,furnitureData in pairs(roomData.furnitures or{}) do
            local furnitureId = furnitureData.id
            local currCgf = furnitureCfg[furnitureId] or {}
            local currLevelCfg = currCgf[furnitureData.level or 0]
            if currLevelCfg and currLevelCfg.power_consume > 0 then
                power = power + currLevelCfg.power_consume
            end
        end
    end

    local buildingPower = GreatBuildingMana:GetPowerImprove()
    power = power + buildingPower
    if self.m_totalPower ~= power then
        self.m_totalPower = power
    end
end

---获取当前电量，当前电量=总电量-消耗电量
function PowerManager:GetCurrentPower()
    return self.m_totalPower - self.m_powerUsed
end

---获取消耗的电量
function PowerManager:GetPowerUsed()
    return self.m_powerUsed
end

---获取总电量
function PowerManager:GetTotalPower()
    return self.m_totalPower
end

EventManager:RegEvent(GameEventDefine.ReCalculatePowerUsed, function(go)
    PowerManager:CalculatePowerUsed()
end)

EventManager:RegEvent(GameEventDefine.ReCalculateTotalPower, function(go)
    PowerManager:CalculateTotalPower()
end)

PowerManager:ctor()

return PowerManager