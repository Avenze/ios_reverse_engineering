---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Microsoft-GXY.
--- DateTime: 2024/8/16 12:28
---
local Class = require("Framework.Lua.Class")
local AIStateBase = require("CodeRefactoring.AI.StateMachines.AIStateBase")
local ActorDefine = require("CodeRefactoring.Actor.ActorDefine")
local PERSON_ACTION = require("CodeRefactoring.Actor.PersonActionDefine")
local UIView = require("Framework.UI.View") -- 当工具类使用
local CycleInstanceDataManager = GameTableDefine.CycleInstanceDataManager
local Vector3 = CS.UnityEngine.Vector3
local UnityHelper = CS.Common.Utils.UnityHelper
local Random = CS.UnityEngine.Random
local CycleCastleAIBlackBoard = GameTableDefine.CycleCastleAIBlackBoard ---@type CycleCastleAIBlackBoard

local WALK_SPEED = 5.5
local RUN_SPEED = 10


---@class CycleCastleClientCome:AIStateBase
---@field m_owner CycleCastleWorker
local CycleCastleClientCome = Class("CycleCastleClientCome",AIStateBase)

function CycleCastleClientCome:ctor()

end

function CycleCastleClientCome:OnEnter(...)
    local actor = self.m_owner
    local actorData = actor.data
    local stateMachine = actor.m_stateMachine
    -- 初始化在工作点
    local startPos = CycleCastleAIBlackBoard.comeStartPos
    local endPos = CycleCastleAIBlackBoard.comeEndPos
    
    actor.gameObject.transform.position = startPos.transform.position
    local speed = RUN_SPEED + Random.Range(-1.1, 1.1)

    local midPos = CycleCastleAIBlackBoard.randomInChilds[math.random(0, CycleCastleAIBlackBoard.randomInChilds.Length - 1)]
    actor:CalculatePath(
        midPos.transform,
        true,
        speed,
        Random.Range(1.1, 4.1),
        function()
            actor:CalculatePath(
                endPos.transform,
                true,
                speed,
                Random.Range(1.1, 4.1),
                function()
                    stateMachine:ChangeState(ActorDefine.CycleInstanceState.CycleCastleClientEat)
                    if actorData.followers then
                        for k, v in pairs(actorData.followers) do
                            v.m_stateMachine:ChangeState(ActorDefine.CycleInstanceState.CycleCastleClientEat)
                        end
                    end
                end
            )
        end
    )


    -- 播放动画
    actor:SetAnimator(PERSON_ACTION.RUN)

end

function CycleCastleClientCome:OnExit()

end

return CycleCastleClientCome