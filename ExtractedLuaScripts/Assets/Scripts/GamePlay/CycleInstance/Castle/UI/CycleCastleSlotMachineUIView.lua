---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2024/6/24 18:22
---
local Class = require("Framework.Lua.Class")
local UIBaseView = require("Framework.UI.View")
---@class CycleCastleSlotMachineUIView:UIBaseView
local CycleCastleSlotMachineUIView = Class("CycleCastleSlotMachineUIView",UIBaseView)
---@type CycleCastleSlotMachineUI
local CycleCastleSlotMachineUI = GameTableDefine.CycleCastleSlotMachineUI
local Timer = GameTimer
local UnityRandom = CS.UnityEngine.Random
local EventManager = require("Framework.Event.Manager")
local ConfigMgr = GameTableDefine.ConfigMgr
local TimerMgr = GameTimeManager
local CycleCastleTaskUI = GameTableDefine.CycleCastleTaskUI
local CycleCastleTaskManager = GameTableDefine.CycleCastleTaskManager
local GameObject = CS.UnityEngine.GameObject
local SoundEngine = GameTableDefine.SoundEngine
local DeviceUtil = CS.Game.Plat.DeviceUtil
local UnityHelper = CS.Common.Utils.UnityHelper ---@type Common.Utils.UnityHelper
local CycleInstanceDataManager = GameTableDefine.CycleInstanceDataManager
local FlyIconsUI = GameTableDefine.FlyIconsUI
local GameUIManager = GameTableDefine.GameUIManager
local UnityTime = CS.UnityEngine.Time

--拉霸机从上往下SlotIndex 顺序为
--3   3   3
--1   1   1 Center
--2   2   2

--有更多时
--4   4   4
--1   1   1 Center
--2   2   2
--3   3   3

--有更多时
--4   4   4
--1   1   1 Center
--2   2   2
--3   3   3

---按顺序停止，第一个停了后随机时间后停止第二个
local SlotStopTimeRangeConfig = {
    [1] = {2.25,2.25},
    [2] = {0.55,0.55},
    [3] = {0.55,0.55},
    [4] = {0.55,0.55}
}

local BigRewardLastSlotStopTime = 3

---拉霸机播放每一格的停止音的时机,停止时间减去的时间
local StopSFXValues = {
    [3] = {
        [1] = 0.45,
        [2] = 0.45,
        [3] = 0.45,
    },
    [4] = {
        [1] = 0.45,
        [2] = 0.45,
        [3] = 0.45,
        [4] = 0.45,
    },
}

local SlotYInterval = 170
---正在使用的竖向个数
local RewardListCount = 3
local NeedCoinBase = 5
local ViewRange = {
    Top = 170,
    Down = -170,
    Height = 340
}
local CircleRange = {10,15}

local SlotMagnificationTips = {
    [1] = "TXT_INSTANCE_CY2_Laba_Magnification1",
    [2] = "TXT_INSTANCE_CY2_Laba_Magnification2",
    [3] = "TXT_INSTANCE_CY2_Laba_Magnification3",
}

---@type SlotGroup
---@field items SlotItem[]
---@field slotValue number 每个格子的位移进度
---@field totalTime number 总时间
---@field time number 剩余时间
---@field startValue number 起始值
---@field finalValue number 最终值，圈数+终点
--@field accumulate number 加速度，用来套公式计算某时间的value
---@field animator UnityEngine.Animator
---@field isRunning boolean
---@field playedSound boolean 是否已经播放停止音效
local SlotGroup = {}
---@type SlotItem
---@field transform UnityEngine.Transform
---@field dynamicBlur DynamicBlur
---@field offSetValue number 相对于中心点的位移
local SlotItem = {}

function CycleCastleSlotMachineUIView:ctor()
    self.m_currentModel = nil ---@type CycleCastleModel

    self.m_slotItemGroups = nil ---@type SlotGroup[]
    self.m_isRunning = false ---@type boolean -老虎机是否正在转动
    self.m_rewardResult = nil ---@type  -最终转动结果
    self.m_playButton = nil ---@type UnityEngine.UI.Button
    self.m_playButton2 = nil ---@type UnityEngine.UI.Button
    self.m_quitBtn = nil ---@type UnityEngine.UI.Button
    self.m_machineAnimator = nil ---@type UnityEngine.Animator
    self.m_tipPanelGO = nil ---@type UnityEngine.GameObject
    self.m_showTipBtn = nil ---@type UnityEngine.UI.Button
    self.m_hideTipBtn = nil ---@type UnityEngine.UI.Button
    --self.m_adBtn = nil      ---@type UnityEngine.UI.Button
    self.m_taskButton = nil ---@type UnityEngine.UI.Button
    self.m_adText = nil      ---@type UnityEngine.UI.Button
    self.m_slotCoinNumText = nil ---@type UnityEngine.UI.TMPLocalization
    --self.m_adTimeText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_adTimesText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_isWaitingForADCallback = false
    self.m_toggles = nil ---@type UnityEngine.UI.Toggle -代币倍率
    self.m_haveCoinNumText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_haveCoinNotEnoughNumText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_needCoinNumText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_blockGO = nil ---@type UnityEngine.GameObject -运行时的阻挡
    self.m_taskRedPointGO = nil ---@type UnityEngine.GameObject
    self.m_curver = nil ---@type Curver
    self.m_starGOList = nil ---@type UnityEngine.GameObject[]
    self.m_TipLeftBtn = nil ---@type UnityEngine.UI.Button
    self.m_TipRightBtn = nil    ---@type UnityEngine.UI.Button
    self.m_showTipLevel = 1 ---当前提示窗口显示的等级
    self.m_upgradeCostNumText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_upgradeNowNumText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_upgradeConditionText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_upgradeConditionGO = nil ---@type UnityEngine.GameObject
    self.m_upgradeRootGO = nil ---@type UnityEngine.GameObject
    self.m_curLevelLights = nil ---@type UnityEngine.GameObject[]
    self.m_maskGO = nil ---@type UnityEngine.GameObject
    self.m_fourthPrecinct = nil ---@type UnityEngine.GameObject
    self.m_triggerTipPanelGO = nil ---@type UnityEngine.GameObject
    self.m_triggerTipText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_taskPopupGO = nil ---@type UnityEngine.GameObject
    self.m_taskPopupText = nil ---@type UnityEngine.UI.TMPLocalization
    self.m_taskPopupBtn = nil ---@type UnityEngine.UI.Button
    self.m_taskPopupTaskID = nil ---当前显示的快捷任务奖励ID
    self.m_moneyText = nil ---@type UnityEngine.UI.TMPLocalization
    
    self.m_runningSoundID = nil ---拉霸机运行的循环音效

    self.m_notShowMagnificationTip = false
end

function CycleCastleSlotMachineUIView:OnEnter()
    self.m_currentModel = CycleInstanceDataManager:GetCurrentModel()
    --按钮
    self.m_playButton = self:GetComp("RootPanel/Body/PushBtn","Button")
    self.m_playButton2 = self:GetComp("RootPanel/Body/PushBtn_2","Button")
    self:SetButtonClickHandler(self.m_playButton,function()
        self:OnPlayButtonClick()
    end)
    self:SetButtonClickHandler(self.m_playButton2,function()
        self:OnPlayButtonClick()
    end)
    self.m_quitBtn = self:GetComp("RootPanel/quitBtn","Button")
    self:SetButtonClickHandler(self.m_quitBtn,function()
        if not self.m_isRunning then
            self:DestroyModeUIObject()
        end
    end)
    self.m_haveCoinNumText = self:GetComp("RootPanel/Body/PushBtn/num/num_1","TMPLocalization")
    self.m_haveCoinNotEnoughNumText = self:GetComp("RootPanel/Body/PushBtn/num/num_3","TMPLocalization")
    self.m_needCoinNumText = self:GetComp("RootPanel/Body/PushBtn/num/num_2","TMPLocalization")
    --Animator
    self.m_machineAnimator = self:GetComp("RootPanel","Animator")

    --tip
    self.m_tipPanelGO = self:GetGo("TipPanel")
    self.m_showTipBtn = self:GetComp("RootPanel/tips","Button")
    self:SetButtonClickHandler(self.m_showTipBtn,function()
        self:ShowTipPanel()
    end)
    self.m_hideTipBtn = self:GetComp("TipPanel/bgcover","Button")
    self:SetButtonClickHandler(self.m_hideTipBtn,handler(self,self.HideTipPanel))
    self.m_tipScrollList = self:GetComp(self.m_tipPanelGO,"bg/ScrollRectEx","ScrollRectEx")
    self:SetListItemNameFunc(self.m_tipScrollList,function(index)
        return "item"..(index+1)
    end)
    self:SetListItemCountFunc(self.m_tipScrollList,function()
        return CycleCastleSlotMachineUI:GetMaxLevel()
    end)
    self.m_tipsGO = {
        self:GetGo("TipPanel/bg/title/level/1"),
        self:GetGo("TipPanel/bg/title/level/2"),
        self:GetGo("TipPanel/bg/title/level/3"),
        self:GetGo("TipPanel/bg/title/level/4"),
        
    }

    self.m_tipScrollList:UpdateData()

    --self.m_tipStarGOList = {}
    local maxLevel = CycleCastleSlotMachineUI:GetMaxLevel()
    --for i = 1, maxLevel do
    --    self.m_tipStarGOList[i] = self:GetGo("TipPanel/bg/title/level/"..i.."/on")
    --end
    self.m_TipLeftBtn = self:GetComp(self.m_tipPanelGO,"bg/title/leftAndRight/leftBtn","Button")
    self:SetButtonClickHandler(self.m_TipLeftBtn,handler(self,self.OnTipLeftBtnDown))
    self.m_TipRightBtn = self:GetComp(self.m_tipPanelGO,"bg/title/leftAndRight/rightBtn","Button")
    self:SetButtonClickHandler(self.m_TipRightBtn,handler(self,self.OnTipRightBtnDown))

    --广告
    --self.m_adBtn = self:GetComp("RootPanel/adBtn","Button")
    --self:SetButtonClickHandler(self.m_adBtn,handler(self,self.PlayAD))
    --self.m_adTimeText = self:GetComp("RootPanel/adBtn/now/txt","TMPLocalization")
    --self.m_adTimesText = self:GetComp("RootPanel/adBtn/num","TMPLocalization")

    --任务按钮
    self.m_taskButton = self:GetComp("RootPanel/taskBtn","Button")
    self:SetButtonClickHandler(self.m_taskButton,function()
        CycleCastleTaskUI:OpenView(self.m_currentModel.instance_id or 4)
    end)
    self.m_taskRedPointGO = self:GetGo("RootPanel/taskBtn/icon")
    self.m_taskPopupGO = self:GetGo("RootPanel/taskBtn/task_popup")
    self.m_taskPopupText = self:GetComp("RootPanel/taskBtn/task_popup/bg/desc","TMPLocalization")
    self.m_taskPopupBtn = self:GetComp(self.m_taskPopupGO,"bg/btn","Button")
    self:SetButtonClickHandler(self.m_taskPopupBtn,function()
        self:FastGetTaskReward()
    end)

    --代币数量
    self.m_slotCoinNumText = self:GetComp("RootPanel/res/num","TMPLocalization")
    --副本货币数量
    self.m_moneyText = self:GetComp("RootPanel/MoneyInterface/num","TMPLocalization")

    --倍率
    local toggleParent = self:GetTrans("RootPanel/Body/Multiple_area")
    self.m_toggles = {}
    for i=1,3 do
        local toggleTrans = toggleParent:GetChild(i-1)
        local toggle = self:GetComp(toggleTrans.gameObject,"","Toggle")
        self.m_toggles[i] = toggle
        local toggleIndex = i
        self:SetToggleValueChangeHandler(toggle,function(isOn)
            if isOn then
                self:OnToggleValueChange(toggleIndex)
            end
        end)
    end

    self.m_blockGO = self:GetGo("RootPanel/block")

    --local freeCoinCount = ConfigMgr.config_global.cycle_instance_freeCoinNum
    --self:SetText("RootPanel/adBtn/icon/txt",tostring(freeCoinCount))
    --self:SetText("RootPanel/adBtn/icon/txt_2",tostring(freeCoinCount))
    self.m_curver = self:GetComp("RootPanel/Body/Slots","Curver")

    --最大等级
    local starParent = self:GetTrans("RootPanel/Body/level")
    local starPrefab = self:GetGo("RootPanel/Body/level/temp")
    self.m_starGOList = {}
    if starPrefab then
        self.m_starGOList[1] = starPrefab
        starPrefab.name = "1"
        for i = 2, maxLevel do
            local starGO = GameObject.Instantiate(starPrefab,starParent)
            self.m_starGOList[i] = starGO
            starPrefab.name = tostring(i)
        end
    end

    --升级按钮与需求
    self.m_upgradeRootGO = self:GetGo("RootPanel/Body/upgradeBtn")
    self.m_upgradeBtn = self:GetComp("RootPanel/Body/upgradeBtn","Button")
    self:SetButtonClickHandler(self.m_upgradeBtn,handler(self,self.OnUpgradeBtnDown))
    self.m_upgradeCostNumText = self:GetComp("RootPanel/Body/upgradeBtn/cash/cost/num","TMPLocalization")
    self.m_upgradeNowNumText = self:GetComp("RootPanel/Body/upgradeBtn/cash/now/num","TMPLocalization")
    self.m_upgradeConditionText = self:GetComp("RootPanel/Body/upgradeBtn/tip/now/num","TMPLocalization")
    self.m_upgradeConditionGO = self:GetGo("RootPanel/Body/upgradeBtn/tip")
    self.m_curLevelLights = {} 
    for i = 1, 4 do
        self.m_curLevelLights[i] = self:GetGo("RootPanel/Body/level/levelIcon_" .. i)
    end
    self.m_maskGO = self:GetGo("RootPanel/Body/Slots/shade")
    self.m_fourthPrecinct = self:GetGo("RootPanel/Body/Slots/4")

    --拉霸机内提示框
    self.m_triggerTipPanelGO = self:GetGo("triggerTip")
    self.m_triggerTipText = self:GetComp(self.m_triggerTipPanelGO,"tipDesc","TMPLocalization")

    --未解锁
    local unlockBtn = self:GetComp(self.m_maskGO,"","Button")
    self:SetButtonClickHandler(unlockBtn,function()
        self:ShowInnerTip("TXT_INSTANCE_CY2_Laba_locked")
    end)

    EventManager:DispatchEvent("PLAY_BGM",nil,{"slot_bgm_instance_5.mp3"})

    --放最后Timer 立刻刷新界面
    self.m_refreshTimer = Timer:CreateNewTimer(1,function()
        self:RefreshCoinNum()
        self:RefreshMoneyNum()
        --self:RefreshADPanel()
        self:RefreshTask()
        self:RefreshUpgradeInfo()
        self:UpdateFastTask()
    end,true,true)
end

function CycleCastleSlotMachineUIView:BuildSlotMachineUIItems()
    --组装
    local slotRoot = self:GetGo("RootPanel/Body/Slots")
    self.m_slotItemGroups = {}
    RewardListCount = CycleCastleSlotMachineUI.RewardCount
    for slotIndex = 1, CycleCastleSlotMachineUI.SlotCount do
        local slotGroup = {} ---@type SlotGroup
        slotGroup.items = {}
        slotGroup.slotValue = 0
        self.m_slotItemGroups[slotIndex] = slotGroup
        for itemIndex = 1, RewardListCount do
            local slotItem = {} ---@type SlotItem
            slotItem.transform = self:GetTrans(slotRoot, slotIndex .."/".. itemIndex)
            slotItem.dynamicBlur = slotItem.transform:GetComponent("DynamicBlur")
            if slotItem.dynamicBlur and slotItem.dynamicBlur:IsNull() then
                slotItem.dynamicBlur = nil
            end
            slotItem.transform.gameObject:SetActive(true)
            slotItem.offSetValue = ((RewardListCount - itemIndex + 1) % RewardListCount) * 1.0 / RewardListCount
            slotGroup.items[itemIndex] = slotItem
            --初始化拉霸机图标
            local iconName = CycleCastleSlotMachineUI:GetSlotSpriteName(slotIndex,itemIndex)
            local iconImage = self:GetComp(slotItem.transform.gameObject,"","Image")
            self:SetSprite(iconImage, "UI_Common", iconName)
            local vfxGO = self:GetGoOrNil(slotItem.transform.gameObject,"fx")
            if vfxGO then
                vfxGO:SetActive(iconName == "icon_cy2_labaNum7")
            end
        end
        slotGroup.animator = self:GetComp("RootPanel/Body/slot_anim/"..slotIndex,"Animator")
        self.m_slotItemGroups[slotIndex] = slotGroup
    end

    --距上面固定1.5
    ViewRange.Top = 0 + 1.5 * SlotYInterval
    ViewRange.Down = 0 - (RewardListCount-1.5) * SlotYInterval
    ViewRange.Height = ViewRange.Top - ViewRange.Down
end

---刷新拉霸机等级
function CycleCastleSlotMachineUIView:RefreshStar()
    local level = self.m_currentModel:GetSlotMachineLevel()
    for i,v in ipairs(self.m_starGOList) do
        local onGO = self:GetGo(v,"on")
        onGO:SetActive(i <= level)
    end
end

function CycleCastleSlotMachineUIView:Init()
    self:BuildSlotMachineUIItems()
    self.m_notShowMagnificationTip = true
    local magIndex = self.m_currentModel:GetCurSlotMagnification()
    self.m_toggles[magIndex].isOn = true
    self.m_notShowMagnificationTip = false
    self:SetRandomValue()
    self:RefreshStar()
end

---给整个拉霸机设置随机起始值
function CycleCastleSlotMachineUIView:SetRandomValue()
    for slotIndex = 1, CycleCastleSlotMachineUI.SlotCount do
        local randomValue = math.random(1,CycleCastleSlotMachineUI.RewardCount) * 1.0 / CycleCastleSlotMachineUI.RewardCount
        self:SetSlotValue(slotIndex,randomValue,0)
    end
end

function CycleCastleSlotMachineUIView:RefreshMoneyNum()
    self.m_moneyText.text = self.m_currentModel:GetCurInstanceCoinShow()
end

function CycleCastleSlotMachineUIView:RefreshCoinNum()
    self.m_slotCoinNumText.text = tostring(self.m_currentModel:GetCurSlotCoin())
    local magIndex = self.m_currentModel:GetCurSlotMagnification()
    local needCoin = NeedCoinBase * CycleCastleSlotMachineUI.SlotMagnificationConfig[magIndex][2]
    local haveCoin = self.m_currentModel:GetCurSlotCoin()
    self.m_needCoinNumText.text = tostring(needCoin)

    if haveCoin >= needCoin then
        self.m_haveCoinNumText.text = tostring(haveCoin)
        self.m_haveCoinNumText.gameObject:SetActive(true)
        self.m_haveCoinNotEnoughNumText.gameObject:SetActive(false)
    else
        self.m_haveCoinNotEnoughNumText.text = tostring(haveCoin)
        self.m_haveCoinNumText.gameObject:SetActive(false)
        self.m_haveCoinNotEnoughNumText.gameObject:SetActive(true)
    end
end

---@param slotIndex number 第几个slot
---@param progress number 0-1 为0时 reward_1 在起点
function CycleCastleSlotMachineUIView:SetSlotValue(slotIndex,progress,slope)
    local mainOffSetValue = progress
    local slotGroup = self.m_slotItemGroups[slotIndex]
    slotGroup.slotValue = mainOffSetValue
    local blurSize = slope
    --printf("SetSlotValue,blurSize = "..blurSize)
    for i = 1,RewardListCount  do
        local uiItem = slotGroup.items[i]
        local pos = uiItem.transform.localPosition
        pos.y = -((mainOffSetValue + uiItem.offSetValue) % 1) * ViewRange.Height
        if pos.y<ViewRange.Down then
            pos.y = pos.y + ViewRange.Height
        end
        uiItem.transform.localPosition = pos
        if uiItem.dynamicBlur then
            uiItem.dynamicBlur:SetBlurSize(blurSize)
        end
    end
end

---最后一个Slot是否停止或者说没在转动
function CycleCastleSlotMachineUIView:IsStop()
    local finalGroup = self.m_slotItemGroups[CycleCastleSlotMachineUI.SlotCount]
    return finalGroup.time>= finalGroup.totalTime
end

---是否不在运行中
function CycleCastleSlotMachineUIView:IsNotRunning()
    return not self.m_isRunning
end

---开始转动
function CycleCastleSlotMachineUIView:Run(rewardResult)
    self.m_isRunning = true
    self.m_blockGO:SetActive(true)

    --是否可能是大奖，可能是大奖时最后一个Slot要多转一会儿
    local mayBeBigReward = CycleCastleSlotMachineUI.m_maybeBigReward
    --设定最终结果,准备计算状态所需的参数
    local preStopTime = 0
    for slotIndex = 1, CycleCastleSlotMachineUI.SlotCount do
        local group = self.m_slotItemGroups[slotIndex]
        if slotIndex == CycleCastleSlotMachineUI.SlotCount and mayBeBigReward then
            preStopTime = preStopTime + BigRewardLastSlotStopTime
        else
            local stopConfig = SlotStopTimeRangeConfig[slotIndex]
            preStopTime = preStopTime + UnityRandom.Range(stopConfig[1],stopConfig[2])
        end
        group.totalTime = preStopTime
        group.time = 0
        local finalRewardValue = 1.0/RewardListCount * (rewardResult[slotIndex]-1)
        --总路程
        local s = math.random(CircleRange[1],CircleRange[2])
        group.startValue = group.slotValue % 1
        group.finalValue = s + finalRewardValue
        --group.accumulate = 2.0*s/(group.totalTime * group.totalTime)
        group.animator:Play("slot_1_2")
        group.isRunning = true
        group.playedSound = false
    end

    --播放拉霸机整体动画
    self.m_machineAnimator:Play("start")
    --播放拉霸机音效
    --SoundEngine:PlaySFX("Assets/Res/Audio/slot_machine_reward.mp3")
    self.m_runningSoundID = SoundEngine:PlaySFX("Assets/Res/Audio/slot_machine_gear.mp3",true)
    self.m_runningTimer = Timer:CreateNewMilliSecTimer(0.3,function()
        --延迟0.3s 等start播放完
        self.m_runningTimer = Timer:CreateNewMilliSecTimer(1,function()
            for slotIndex = 1, CycleCastleSlotMachineUI.SlotCount do
                local slotGroup = self.m_slotItemGroups[slotIndex]
                if slotGroup.isRunning then
                    slotGroup.time = math.min(slotGroup.time + UnityTime.deltaTime,slotGroup.totalTime)
                    --local slotValue
                    --if slotGroup.time<slotGroup.totalTime*0.5 then
                    --    --前半路程计算公式 S1 = S0 + 0.5 * a * t * t
                    --    slotValue = slotGroup.startValue + 0.5 * slotGroup.accumulate * slotGroup.time * slotGroup.time
                    --else
                    --    --后半路程计算公式 S1 = S2 - 0.5 * a * (totalTime-t) * (totalTime-t)
                    --    local t2 = slotGroup.totalTime - slotGroup.time
                    --    slotValue = slotGroup.finalValue -0.5 * slotGroup.accumulate * t2 * t2
                    --end
                    local curverTime = slotGroup.time/slotGroup.totalTime
                    local curverValue,curverSlope
                    if mayBeBigReward and slotIndex == CycleCastleSlotMachineUI.SlotCount then
                        curverValue = self.m_curver:GetCurveValue("BigReward",curverTime)
                        curverSlope = self.m_curver:GetSlopeAtTime("BigReward",curverTime)
                    else
                        curverValue = self.m_curver:GetCurveValue("Slot",curverTime)
                        curverSlope = self.m_curver:GetSlopeAtTime("Slot",curverTime)
                    end
                    local slotValue = slotGroup.startValue + curverValue * (slotGroup.finalValue - slotGroup.startValue)

                    if slotGroup.time >= slotGroup.totalTime then
                        curverSlope = 0
                    end

                    self:SetSlotValue(slotIndex,slotValue,curverSlope)
                    if slotGroup.time >= slotGroup.totalTime - StopSFXValues[CycleCastleSlotMachineUI.SlotCount][slotIndex] then
                        --提前播放音效
                        if not slotGroup.playedSound then
                            SoundEngine:PlaySFX("Assets/Res/Audio/SLOT_"..slotIndex..".mp3")
                            slotGroup.playedSound = true
                            if slotIndex == CycleCastleSlotMachineUI.SlotCount then
                                if self.m_runningSoundID then
                                    SoundEngine:StopSFX(self.m_runningSoundID)
                                    self.m_runningSoundID = nil
                                end
                            end
                        end
                    end
                    if slotGroup.time >= slotGroup.totalTime then
                        slotGroup.isRunning = false
                        slotGroup.animator:Play("slot_1_3")
                        DeviceUtil.StartVibrate()
                    end
                end
            end
            --检查最后一个是否停止
            if self:IsStop() then
                --展示结果
                self:OnStop()
            end
        end,true)
    end)
end

---转盘停止，输出奖励
function CycleCastleSlotMachineUIView:OnStop()

    self.m_machineAnimator:Play("idle")
    Timer:StopTimer(self.m_runningTimer)
    self.m_runningTimer = nil
    self.m_isRunning = false
    self.m_blockGO:SetActive(false)

    if not self.m_rewardResult then
        printf("奖励结果是 nil")
        return
    end

    CycleCastleSlotMachineUI:GetRewards()
    self.m_rewardResult = nil
end

---改变倍率
function CycleCastleSlotMachineUIView:OnToggleValueChange(index)
    self.m_currentModel:SetCurSlotMagnification(index)
    self:RefreshCoinNum()
    if not self.m_notShowMagnificationTip then
        self:ShowInnerTip(SlotMagnificationTips[index])
        SoundEngine:PlaySFX(SoundConst.BUTTON_CLICK_SFX)
    end
end

---按钮按下，要判断是否能转动
function CycleCastleSlotMachineUIView:OnPlayButtonClick()
    if self.m_isRunning then
        return
    end

    --扣除代币
    local haveCoins = self.m_currentModel:GetCurSlotCoin()
    local magIndex = self.m_currentModel:GetCurSlotMagnification()
    local needCoins = NeedCoinBase * CycleCastleSlotMachineUI.SlotMagnificationConfig[magIndex][2]
    if haveCoins>= needCoins and self.m_currentModel:ChangeSlotCoin(-needCoins) then
        self.m_rewardResult = CycleCastleSlotMachineUI:Push()
        self:Run(self.m_rewardResult)
    else
        --printf("代币不够请前往购买")
        GameTableDefine.ChooseUI:Choose("TXT_INSTANCE_SHOP_TIP",function()
            GameTableDefine.CycleCastleShopUI:GetView()
            --self:DestroyModeUIObject()
        end)
    end
end

--region 等级提示

function CycleCastleSlotMachineUIView:RefreshTipInfos()
    self.m_tipScrollList:SetSnapIndex(self.m_showTipLevel - 1)

    self.m_TipLeftBtn.gameObject:SetActive(self.m_showTipLevel>1)
    self.m_TipRightBtn.gameObject:SetActive(self.m_showTipLevel<CycleCastleSlotMachineUI:GetMaxLevel())
    
    for k,v in pairs(self.m_tipsGO) do
        v:SetActive(k == self.m_showTipLevel)
    end
    --for i,v in ipairs(self.m_tipStarGOList) do
    --    v:SetActive(i <= self.m_showTipLevel)
    --end
end

function CycleCastleSlotMachineUIView:ShowTipPanel(level)
    self.m_tipPanelGO:SetActive(true)
    self.m_showTipLevel = level or self.m_currentModel:GetSlotMachineLevel()
    self:RefreshTipInfos()
end

function CycleCastleSlotMachineUIView:HideTipPanel()
    self.m_tipPanelGO:SetActive(false)
end

function CycleCastleSlotMachineUIView:OnTipLeftBtnDown()
    if self.m_showTipLevel > 1 then
        self.m_showTipLevel = self.m_showTipLevel - 1
        self:RefreshTipInfos()
    end
end

function CycleCastleSlotMachineUIView:OnTipRightBtnDown()
    if self.m_showTipLevel < CycleCastleSlotMachineUI:GetMaxLevel() then
        self.m_showTipLevel = self.m_showTipLevel + 1
        self:RefreshTipInfos()
    end
end
--endregion

--function CycleCastleSlotMachineUIView:RefreshADPanel()
--    local curTimes = self.m_currentModel:GetCurADFreeSlotCoinTimes()
--    local canGetTimes = ConfigMgr.config_global.cycle_instance_freeCoinFre
--    self.m_adTimesText.text = (canGetTimes-curTimes).."/"..canGetTimes
--
--    if canGetTimes>curTimes then
--        local cdTime = self.m_currentModel:GetSlotADFreeCoinCDTime()
--        if cdTime>0 then
--            self.m_adTimeText.text = TimerMgr:FormatTimeLength(cdTime)
--
--            self.m_adBtn.interactable = false
--        else
--            --self.m_adTimeText.text = GameTextLoader:ReadText("TXT_BTN_CLAIM")
--            self.m_adTimeText.text = ""
--            self.m_adBtn.interactable = not self.m_isWaitingForADCallback
--        end
--    else
--        self.m_adBtn.interactable = false
--        self.m_adBtn.gameObject:SetActive(false)
--    end
--end

---刷新任务按钮红点
function CycleCastleSlotMachineUIView:RefreshTask()
    self.m_taskRedPointGO:SetActive(CycleCastleTaskManager:IsAnyTaskIsComplete())
end

---播放广告给代币
--function CycleCastleSlotMachineUIView:PlayAD()
--
--    local curTimes = self.m_currentModel:GetCurADFreeSlotCoinTimes()
--    local cdTime = self.m_currentModel:GetSlotADFreeCoinCDTime()
--    local canGetTimes = ConfigMgr.config_global.cycle_instance_freeCoinFre
--
--    if curTimes >= canGetTimes or cdTime > 0 then
--        return
--    end
--
--    self.m_isWaitingForADCallback = true
--    GameSDKs:PlayRewardAd(function()
--                self.m_currentModel:GetOneTimeSlotADFreeCoin()
--                local coinNum = ConfigMgr.config_global.cycle_instance_freeCoinNum
--                GameTableDefine.FlyIconsUI:SetCycleInstanceNum({{itemType = 30,str = coinNum}})
--            end,
--            function()
--                self.m_isWaitingForADCallback = false
--            end,
--            function()
--                EventManager:DispatchEvent("UI_NOTE", GameTextLoader:ReadText("TXT_TIP_NO_AD"))
--                self.m_isWaitingForADCallback = false
--            end,
--            10013)
--end

function CycleCastleSlotMachineUIView:PlayFlyIcon(flyIconPath,isFull,showValue)
    local flyIconGO = self:GetGo(flyIconPath)
    local flyIconAnimator = self:GetComp(flyIconGO,"","Animator")
    flyIconGO:SetActive(true)
    flyIconAnimator:Play(isFull and "Full" or "Normal" ,0,0.0)
    local numText = self:GetComp(flyIconGO,"num/num","TMPLocalization")
    numText.text = "+"..showValue
    SoundEngine:PlaySFX("Assets/Res/Audio/SFX_reward.ogg")
end

function CycleCastleSlotMachineUIView:PlayFlyIconSkill(flyIconPath,isFull,skillInfos)
    if self.m_flyIconSkillTimer then
        return
    end
    SoundEngine:PlaySFX("Assets/Res/Audio/SFX_reward.ogg")
    local flyIconGO = self:GetGo(flyIconPath)
    local skillGOParentGO = isFull and self:GetGo(flyIconGO,"list_1") or self:GetGo(flyIconGO,"list_2")
    local flyIconAnimation = self:GetComp(flyIconGO,"","Animation")
    flyIconGO:SetActive(true)
    local showTime = flyIconAnimation.clip.length
    local skillTempGO = self:GetGo(skillGOParentGO,"temp")
    local skillGOs = {}
    skillGOParentGO:SetActive(true)
    for k,v in pairs(skillInfos) do
        if v>0 then
            local skillGO = GameObject.Instantiate(skillTempGO,skillGOParentGO.transform)
            table.insert(skillGOs,skillGO)
            local numText = self:GetComp(skillGO,"num/num","TMPLocalization")
            numText.text = "+"..v
            local iconImage = self:GetComp(skillGO,"icon","Image")
            self:SetSprite(iconImage,"UI_Common","icon_cy2_skill_"..k)
            skillGO:SetActive(true)
        end
    end
    self.m_flyIconSkillTimer = Timer:CreateNewTimer(showTime,function()
        for k,v in pairs(skillGOs) do
            GameObject.Destroy(v)
        end
        flyIconGO:SetActive(false)
        skillGOParentGO:SetActive(false)
        self.m_flyIconSkillTimer = nil
    end)
    --flyIconAnimator:Play(isFull and "Full" or "Normal" ,0,0.0)
end

function CycleCastleSlotMachineUIView:OnExit()
    if self.m_refreshTimer then
        Timer:StopTimer(self.m_refreshTimer)
        self.m_refreshTimer = nil
    end
    if self.m_flyIconSkillTimer then
        Timer:StopTimer(self.m_flyIconSkillTimer)
        self.m_flyIconSkillTimer = nil
    end
    if self.m_tipTimer then
        Timer:StopTimer(self.m_tipTimer)
        self.m_tipTimer = nil
    end

    EventManager:DispatchEvent("STOP_BGM")
end

---刷新拉霸机升级按钮和需求
function CycleCastleSlotMachineUIView:RefreshUpgradeInfo()
    local curLevel = self.m_currentModel:GetSlotMachineLevel()
    self:SetText("RootPanel/Body/level/levelNum", curLevel)
    for i = 1, #self.m_curLevelLights do
        self.m_curLevelLights[i]:SetActive(curLevel >= i)
    end
    if curLevel >= 3 then
        self.m_maskGO:SetActive(false)
        self.m_fourthPrecinct:SetActive(true) 
    else
        self.m_maskGO:SetActive(true)
        self.m_fourthPrecinct:SetActive(false)
    end
    
    local canUpgrade, roomID, cost = CycleCastleSlotMachineUI:GetUpgradeCondition()
    if not canUpgrade and not roomID then
        --没有下一级
        self.m_upgradeRootGO:SetActive(false)
        return
    else
        self.m_upgradeRootGO:SetActive(true)
    end
    self.m_upgradeBtn.interactable = canUpgrade

    self.m_upgradeNowNumText.text = BigNumber:FormatBigNumber(self.m_currentModel:GetCurInstanceCoin())
    self.m_upgradeCostNumText.text = BigNumber:FormatBigNumber(cost)

    if not self.m_currentModel.roomsData[roomID] or self.m_currentModel.roomsData[roomID].state ~= 2 then
        local roomName = GameTextLoader:ReadText(self.m_currentModel.roomsConfig[roomID].name)
        local requireRoomStr = GameTextLoader:ReadText("TXT_INSTANCE_SLOT_UPGRADE")
        requireRoomStr = string.gsub(requireRoomStr,"%[roomName%]",roomName)
        self.m_upgradeConditionText.text = requireRoomStr
        self.m_upgradeConditionGO:SetActive(true)
        self.m_upgradeBtn.interactable = false
    else
        self.m_upgradeConditionGO:SetActive(false)
    end
    local tmp = self:GetComp("RootPanel/Body/upgradeBtn/cash/now/num", "TMPLocalization")
    if BigNumber:CompareBig(cost, CycleInstanceDataManager:GetCurrentModel():GetCurInstanceCoin()) then
        tmp.color = UnityHelper.GetColor("#FF2021")
    else
        tmp.color = UnityHelper.GetColor("#FFFFFF")
    end

end

function CycleCastleSlotMachineUIView:OnUpgradeBtnDown()
    local canUpgrade,roomID,cost = CycleCastleSlotMachineUI:GetUpgradeCondition()
    if canUpgrade then
        self.m_currentModel:AddCurInstanceCoin(-cost)
        self.m_currentModel:SetSlotMachineLevel(self.m_currentModel:GetSlotMachineLevel() + 1)

        CycleCastleSlotMachineUI:Init()
        --升级后重新初始化拉霸机界面
        self:BuildSlotMachineUIItems()
        self:SetRandomValue()
        self:RefreshStar()

        self:RefreshUpgradeInfo()

        --拉霸机升级后，等播完飞图标，弹出升级后的数值提示变化
        GameUIManager:SetEnableTouch(false)
        Timer:CreateNewTimer(1.8,function()
            self:ShowTipPanel(self.m_currentModel:GetSlotMachineLevel() - 1)
            Timer:CreateNewTimer(0.8,function()
                self:ShowTipPanel(self.m_currentModel:GetSlotMachineLevel())
                GameUIManager:SetEnableTouch(true)
            end)
        end)
    end
end

---显示拉霸机内部文字提示
function CycleCastleSlotMachineUIView:ShowInnerTip(textID)
    self.m_triggerTipText.text = GameTextLoader:ReadText(textID)
    self.m_triggerTipPanelGO:SetActive(true)
    if self.m_tipTimer then
        Timer:StopTimer(self.m_tipTimer)
    end
    self.m_tipTimer = Timer:CreateNewTimer(1,function()
        self.m_triggerTipPanelGO:SetActive(false)
        self.m_tipTimer = nil
    end)
end

---刷新快速任务的内容,每秒刷新
function CycleCastleSlotMachineUIView:UpdateFastTask()
    local completeTaskID = CycleCastleTaskManager:GetCompleteTaskIDToShowInSlotMachine()
    if completeTaskID then
        if completeTaskID ~= self.m_taskPopupTaskID then
            self.m_taskPopupTaskID = completeTaskID
            self.m_taskPopupGO:SetActive(false)
            self.m_taskPopupGO:SetActive(true)
            local descStr,haveStr,needStr,isComplete = CycleCastleTaskManager:GetTaskShowValues(completeTaskID)
            self.m_taskPopupText.text = descStr
        end
    else
        self.m_taskPopupTaskID = nil
        self.m_taskPopupGO:SetActive(false)
    end
end

---快速获取任务奖励
function CycleCastleSlotMachineUIView:FastGetTaskReward()
    if self.m_taskPopupTaskID then
        local taskConfig = CycleCastleTaskManager:GetTaskConfigByTaskID(self.m_taskPopupTaskID)
        local getReward = false
        if taskConfig.taskShowType == 1 then
            getReward = CycleCastleTaskManager:CompleteType1Task(taskConfig.id)
        else
            getReward = CycleCastleTaskManager:CompleteTask(taskConfig.id)
        end
        if getReward then
            local res = {} ---@type CycleFlyIconResInfo[]
            local rewardValue = taskConfig.value
            self.m_currentModel:ChangeSlotCoin(rewardValue)
            --快捷任务奖励拉霸机代币是301
            local resInfo = {itemType = 301,str = rewardValue} ---@type CycleFlyIconResInfo
            table.insert(res,resInfo)

            FlyIconsUI:SetCycleInstanceNum(res)
        end
        self:UpdateFastTask()
    end
end

return CycleCastleSlotMachineUIView