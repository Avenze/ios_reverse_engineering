---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2024/6/28 15:00
---

local Class = require("Framework.Lua.Class")
local UIView = require("Framework.UI.View")
local EventManager = require("Framework.Event.Manager")
local ViewUtils = require("GamePlay.Utils.ViewUtils")
local GameResMgr = require("GameUtils.GameResManager")

local FileHelper = CS.Common.Utils.FileHelper
local AnimationUtil = CS.Common.Utils.AnimationUtil
local UnityHelper = CS.Common.Utils.UnityHelper
local Color = CS.UnityEngine.Color
local GameObject = CS.UnityEngine.GameObject
local Vector3 = CS.UnityEngine.Vector3

local CycleInstanceDataManager = GameTableDefine.CycleInstanceDataManager
local ResourceManger = GameTableDefine.ResourceManger
local ConfigMgr = GameTableDefine.ConfigMgr
local SettingUI = GameTableDefine.SettingUI
--local InstanceMilepostUI = GameTableDefine.InstanceMilepostUI
local InstanceProcessUI = GameTableDefine.InstanceProcessUI
--local CycleIslandTimeUI = GameTableDefine.CycleIslandTimeUI
local CycleCastleShopUI = GameTableDefine.CycleCastleShopUI
--local InstanceAdUI = GameTableDefine.InstanceAdUI
local CycleCastleTaskManager = GameTableDefine.CycleCastleTaskManager
--local InstanceUnlockUI = GameTableDefine.InstanceUnlockUI
--local InstanceBuildingUI = GameTableDefine.InstanceBuildingUI
local GameUIManager = GameTableDefine.GameUIManager
local CycleCastleTaskUI = GameTableDefine.CycleCastleTaskUI
local CycleCastleSlotMachineUI = GameTableDefine.CycleCastleSlotMachineUI
local CycleCastleSkillUI = GameTableDefine.CycleCastleSkillUI
local CycleCastleMilepostUI = GameTableDefine.CycleCastleMilepostUI
local CycleCastlePopUI = GameTableDefine.CycleCastlePopUI
local CycleCastleSellUI = GameTableDefine.CycleCastleSellUI
local ShopManager = GameTableDefine.ShopManager
local SoundEngine = GameTableDefine.SoundEngine
local GuideManager = GameTableDefine.GuideManager
local CycleCastleRankUI = GameTableDefine.CycleCastleRankUI

---@class CycleCastleMainViewUIView:UIBaseView
local CycleCastleMainViewUIView = Class("CycleCastleMainViewUIView", UIView)
local notifyPopLength = 10  --通知气泡数量上线
local currentNotifyCount = 0
local employeeNotify = nil
local moneyNotify = nil
local milestoneNotify = nil
local notifyList = {}

function CycleCastleMainViewUIView:ctor()
    self.super:ctor()
    self.m_data = {}

    --self.m_milestoneAnimation = nil ---@type UnityEngine.Animation

    --self.m_openSellUIBtn = nil ---@type UnityEngine.UI.Button

    self.m_taskDoneGO = nil ---@type UnityEngine.GameObject
end

function CycleCastleMainViewUIView:Exit()
    local txt = GameTextLoader:ReadText("TXT_INSTANCE_TIP_RETURN")
    GameTableDefine.ChooseUI:CommonChoose(txt, function()
        if GameTableDefine.CycleCastleRankManager:ReportCheck() then
            GameTableDefine.CycleCastleRankManager:ReportRank()
        end

        self:DestroyModeUIObject()
    end, true, nil)
end

function CycleCastleMainViewUIView:OnEnter()

    --TODO:
    --测试显示当前资源产出数量的UI
    self:OpenTestResWatch()
    if self.curInstanceTimer then
        GameTimer:StopTimer(self.curInstanceTimer)
        self.curInstanceTimer = nil
    end
    self:SetText("Milestone/progLevel/progress", CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel())
    self:SetText("Milestone/progLevel/limit", Tools:GetTableSize(CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward))
    self.curInstanceTimer = GameTimer:CreateNewTimer(1, function()
        self:UpdateOnSecond()
    end, true, true)
    --返回主场景
    self:SetButtonClickHandler(self:GetComp("ReturnBtn","Button"), function()
        self:Exit()
    end)
    --设置按钮
    --local settingGo = self:GetGoOrNil("DetailPanel/SettingBtn")
    --if settingGo then
    --    settingGo:SetActive(false)
    --end
    --self:SetButtonClickHandler(self:GetComp("DetailPanel/SettingBtn","Button"),function()
    --    -- SettingUI:GetView()
    --    -- local curLevel = InstanceDataManager:GetCurInstanceKSLevel()
    --    -- InstanceDataManager:SetCurInstanceKSLevel(curLevel + 1)
    --end)
    --打开商店按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/ShopBtn","Button"),function()
        CycleCastleShopUI:GetView()
    end)
    --打开生产线界面
    self:SetButtonClickHandler(self:GetComp("BottomPanel/ProductBtn","Button"),function()
        InstanceProcessUI:ShowView()
    end)

    --时间按钮
    --self:SetButtonClickHandler(self:GetComp("ResourceBG/CurrTimeFrame","Button"),function()
    --    CycleIslandTimeUI:GetView()
    --end)
    --里程碑按钮
    --self:SetButtonClickHandler(self:GetComp("DetailPanel/milestone/milestoneBtn","Button"),function()
    --    InstanceMilepostUI:OpenUI()
    --end)
    --任务按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/TaskBtn","Button"),function()
        CycleCastleTaskUI:OpenView()
    end)

    --拉霸机按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/SlotBtn","Button"),function()
        CycleCastleSlotMachineUI:OpenView(CycleInstanceDataManager:GetCurrentModel().instance_id or 1)
    end)

    --技能面板按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/SkillBtn", "Button"), function()
        CycleCastleSkillUI:ShowSkillPanel()
    end)

    --里程碑界面入口设置
    self:SetButtonClickHandler(self:GetComp("Milestone", "Button"), function()
        local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(14020)
        if guide2IsComplete then
            CycleCastleMilepostUI:ShowMilepostPanel()
        end
    end)

    --礼包按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/PackBtn", "Button"), function()
        CycleCastlePopUI:OpenView()
    end)

    --港口按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/SellBtn", "Button"), function()
        GameUIManager:SetEnableTouch(false)
        local sellsID = CycleInstanceDataManager:GetCurrentModel():GetRoomDataByType(4)
        local sellID = sellsID[1].roomID
        CycleInstanceDataManager:GetCurrentModel():GetScene():LookAtSceneGO(sellID,nil,nil,nil,function()
            CycleCastleSellUI:ShowWharfUI(sellID)
            GameUIManager:SetEnableTouch(true)
        end)
    end)
    --充值钻石按钮
    self:SetButtonClickHandler(self:GetComp("ResourceBG/DiamondInterface/AddBtn", "Button"), function()
        GameTableDefine.CycleCastleShopUI:OpenAndTurnPage(1000)
    end)

    --点击工人按钮
    self:SetButtonClickHandler(self:GetComp("ResourceBG/EmployeeInterface","Button"),function()
        self:GetGo("HelpInfo_employee"):SetActive(true)
        local hungry,physical,debugWorker = self:GetDebuffCount()
        --state
        self:GetGo("HelpInfo_employee/frame/state/info/hunger"):SetActive(hungry > 0)
        self:GetGo("HelpInfo_employee/frame/state/info/physical"):SetActive(physical > 0)
        self:SetText("HelpInfo_employee/frame/state/info/hunger/num",hungry)
        self:SetText("HelpInfo_employee/frame/state/info/physical/num",physical)
        --desc
        self:GetGo("HelpInfo_employee/frame/desc/hunger"):SetActive(hungry > 0)
        self:GetGo("HelpInfo_employee/frame/desc/physical"):SetActive(physical > 0)
        local hungryStr1 = GameTextLoader:ReadText("TXT_INSTANCE_TIP_HUNGER")
        local hungryStr = string.gsub(hungryStr1,"{0}",tostring(hungry))
        local physicalStr1 = GameTextLoader:ReadText("TXT_INSTANCE_TIP_PHYSICAL")
        local physicalStr = string.gsub(physicalStr1,"{0}",tostring(physical))
        self:SetText("HelpInfo_employee/frame/desc/hunger",hungryStr)
        self:SetText("HelpInfo_employee/frame/desc/physical",physicalStr)
    end)

    --EventInstance按钮
    self:SetButtonClickHandler(self:GetComp("EventArea/IAA","Button"),function() 
        GameTableDefine.CycleCastleAdUI:GetView()
    end)


    --self.m_milestoneAnimation = self:GetComp("DetailPanel/milestone","Animation")

    self:InitView()

    --region 排行榜
    self:SetButtonClickHandler(self:GetComp("ActivityPanel/RankAct", "Button"),function()
        CycleCastleRankUI:GetView()
    end)
    
    self:GetGo("ActivityPanel/RankAct"):SetActive(false)
    EventManager:RegEvent(GameEventDefine.RefreshCastleRankNum, function(rank_num)
        self:SetText("ActivityPanel/RankAct/rank", rank_num)
        self:GetGo("ActivityPanel/RankAct"):SetActive(true)
    end)

    GameTableDefine.CycleCastleRankManager:EnterCycleCastleInstanceMainUI()
    --endregion
end

---一秒一次的副本主界面刷新
function CycleCastleMainViewUIView:UpdateOnSecond()
    local timeRemaining = 0
    local state = CycleInstanceDataManager:GetInstanceState()
    if state == CycleInstanceDataManager.instanceState.isActive then
        timeRemaining = CycleInstanceDataManager:GetLeftInstanceTime()
    else
        --副本结束后持续显示为0
        timeRemaining = 0
    end
    -- local h = os.date("%d", timeRemaining) * 24 + os.date("%H", timeRemaining)
    -- local m = os.date("%M", timeRemaining)
    local timeStr =  GameTimeManager:FormatTimeLength(timeRemaining)
    self:SetText("Milestone/timer/num", timeStr)
    --里程碑节点
    self:RefreshMilestone()
    --码头红点
    local income, roomID, resID = CycleInstanceDataManager:GetCurrentModel():GetCurHighestProfit()
    local curResID = CycleInstanceDataManager:GetCurrentModel():GetCurSellingProduct()
    self:GetGo("BottomPanel/SellBtn/icon"):SetActive(curResID ~= resID)

end

function CycleCastleMainViewUIView:OnExit()
    EventManager:UnregEvent(GameEventDefine.RefreshCastleRankNum)
    --GameTableDefine.CycleCastleRankManager:ExistCycleCastleInstanceMainUI()
    
    if self.timer then
        GameTimer:_RemoveTimer(self.timer)
    end
    if self.curInstanceTimer then
        GameTimer:StopTimer(self.curInstanceTimer)
        self.curInstanceTimer = nil
    end
    if self.m_refreshTaskTimer then
        GameTimer:StopTimer(self.m_refreshTaskTimer)
        self.m_refreshTaskTimer = nil
    end
    self:CloseTestResWatch()

    -- 排行榜新增事件
    if self.rank_timer then
        GameTimer:StopTimer(self.rank_timer)
    end
    
    
	self.super:OnExit(self)
end

function CycleCastleMainViewUIView:InitView()
    self:Show()
    self:CheckLastOneDay()
    self.timer = GameTimer:CreateNewTimer(0.5,function()
        local curTime = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceTime(CycleInstanceDataManager:GetCurrentModel().instance_id or 4)
        local hStr = curTime.Hour
        if curTime.Hour < 10 then
            hStr = "0"..curTime.Hour
        end
        local mStr = curTime.Min
        if curTime.Min < 10 then
            mStr = "0"..curTime.Min
        end
        self:SetText("ResourceBG/CurrTimeFrame/CurrTime",string.format("%s:%s",hStr,mStr))
        --local isDay = InstanceModel:IsDay()
        --self:GetGo("ResourceBG/CurrTimeFrame/icon_day"):SetActive(isDay)
        --self:GetGo("ResourceBG/CurrTimeFrame/icon_night"):SetActive(not isDay)
        local curTimeType = CycleInstanceDataManager:GetCurrentModel().timeType
        for i = 1, 3 do
            self.timeTypeUI[i]:SetActive(i == curTimeType)
        end

        --local timeRemaining = CycleInstanceDataManager:GetLeftInstanceTime()
        --local h = math.floor( timeRemaining / 3600 )
        --local m = math.floor( timeRemaining % 86400 % 3600 /60 )

        --local timeStr =  string.format("%dh%dm", h,m)
        --self:SetText("DetailPanel/milestone/timer/num",timeStr)

        self:RefreshPackButton()

    end,true,true)

    -- 刷新排行榜剩余时间
    self.rank_timer = GameTimer:CreateNewTimer(1, function()
        local remain_time = GameTableDefine.CycleCastleRankManager:GetRemainTime() -- 活动剩余时间转换
        if remain_time >= 0 then
            self:SetText("ActivityPanel/RankAct/time", Tools:FormatTime(remain_time))
        else
            if self.rank_timer then
                GameTimer:StopTimer(self.rank_timer)
                self.rank_timer = nil
            end
        end
    end, true, true)
    
    --初始化通知弹窗
    self:InitNotifyPop(notifyPopLength)
    --开启按钮状态的刷新
    self:StartRefreshButtonTips()
    self:RefreshUIEntryByGuideState()
end


function CycleCastleMainViewUIView:InitNotifyPop(length)
    employeeNotify = self:GetGo("Notify/employee")
    moneyNotify = self:GetGo("Notify/money")
    milestoneNotify = self:GetGo("Notify/milestone")
end

--[[
    @desc: 
    author:{author}
    time:2023-05-10 15:37:12
    --@notifyType:1:新员工  2:得钱  3:彩蛋
	--@args: 
    @return:
]]
function CycleCastleMainViewUIView:CallNotify(notifyType,...)
    if currentNotifyCount < 10 then
        self:GetNotify(notifyType,...)
    else
        local notify1 = notifyList[1]
        table.remove(notifyList,1)
        self:RecycleNotify(notifyType,notify1)
        self:GetNotify(notifyType,...)
    end
    
end

function CycleCastleMainViewUIView:GetNotify(notifyType,...)
    currentNotifyCount = currentNotifyCount + 1
    if notifyType == 1 then -- 员工
        local callback = function(go,id,...)
            self:SetText(go,"bg/content/txt",GameTextLoader:ReadText("TXT_INSTANCE_NOTIFY_EMPLOYEE"))

            go.transform:SetAsFirstSibling()    --将该节点移到父物体的第一个子节点位置
            local feel = self:GetComp(go,"openFB","MMFeedbacks")
            feel.Events.OnComplete:AddListener(function()
                self:RecycleNotify(notifyType,go)
            end)
            table.insert(notifyList,go)
        end
        Tools:SetTempGo(employeeNotify,1,false,callback)
        
    elseif notifyType == 2 then -- 得钱
        local callback = function(go,id,...)
            local money = select (1,...)
            money = BigNumber:FormatBigNumber(money)
            self:SetText(go,"bg/content/txt","+"..money)
            local resCfg = select (2,...)
            local Image = self:GetComp(go,"bg/category/icon","Image")
            self:SetSprite(Image,"UI_Common",resCfg.icon)

            go.transform:SetAsFirstSibling()    --将该节点移到父物体的第一个子节点位置
            local feel = self:GetComp(go,"openFB","MMFeedbacks")
            feel.Events.OnComplete:AddListener(function()
                self:RecycleNotify(notifyType,go)
            end)

            SoundEngine:PlaySFX("Assets/Res/Audio/SFX_income.ogg", false)
            table.insert(notifyList,go)
        end
        Tools:SetTempGo(moneyNotify,1,false,callback,...)
    elseif notifyType == 3 then -- 得彩蛋
        local callback = function(go,id,...)
            local level = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel()
            local rewardConfig = ConfigMgr.config_cy_instance_reward[CycleInstanceDataManager:GetCurrentModel().instance_id or 4][level]
            local rewardShopConfig = ConfigMgr.config_shop[rewardConfig.shop_id]
            local Image = self:GetComp(go,"bg/category/icon","Image")
            self:SetSprite(Image,"UI_Common",rewardShopConfig.icon)

            go.transform:SetAsFirstSibling()    --将该节点移到父物体的第一个子节点位置
            local feel = self:GetComp(go,"openFB","MMFeedbacks")
            feel.Events.OnComplete:AddListener(function()
                self:RecycleNotify(notifyType,go)
            end)
        end
        Tools:SetTempGo(milestoneNotify,1,false,callback,...)
    end
end

function CycleCastleMainViewUIView:RecycleNotify(notifyType,notifyGO)
    for i=1,#notifyList do
        if notifyList[i] == notifyGO then
            table.remove( notifyList,i)
            break
        end
    end
    currentNotifyCount = currentNotifyCount -1
    GameObject.Destroy(notifyGO)
end


function CycleCastleMainViewUIView:Show()

    --资源栏
    --钱
    local moneyStr = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceCoinShow()
    self:SetText("ResourceBG/MoneyInterface/num",moneyStr)

    --英雄经验
    local heroExpStr = CycleInstanceDataManager:GetCurrentModel():GetCurHeroExpResShow()
    self:SetText("ResourceBG/ExpInterface/num",heroExpStr)

    --钻石
    local diamond = ResourceManger:GetDiamond()
    local diamondStr = Tools:SeparateNumberWithComma(diamond)
    self:SetText("ResourceBG/DiamondInterface/num",diamondStr)
    --
    --local hungry,physical,debugWorker,workerCount = self:GetDebuffCount()
    --local workerButton = self:GetComp("ResourceBG/EmployeeInterface","Button")
    --local worlerIcon = self:GetGo("ResourceBG/EmployeeInterface/tipBtn")
    --if debugWorker > 0 then
    --    local showStr = Tools:ChangeTextColor(debugWorker,"ff0000").."/"..workerCount
    --    self:SetText("ResourceBG/EmployeeInterface/CurrPeople",showStr)
    --    workerButton.interactable = true
    --    worlerIcon:SetActive(true)
    --else
    --    self:SetText("ResourceBG/EmployeeInterface/CurrPeople",workerCount)
    --    workerButton.interactable = false
    --    workerButton.interactable = false
    --    worlerIcon:SetActive(false)
    --end
    local timeType1 = self:GetGo("ResourceBG/CurrTimeFrame/1")
    local timeType2 = self:GetGo("ResourceBG/CurrTimeFrame/2")
    local timeType3 = self:GetGo("ResourceBG/CurrTimeFrame/3")
    self.timeTypeUI = {
        [1] = timeType1,
        [2] = timeType2,
        [3] = timeType3
    }
    --
    ----里程碑信息栏
    local currentAchievement = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel()
    local maxLevel = CycleInstanceDataManager:GetCurrentModel():GetMaxAchievementLevel()

    local notClaimedLevel = CycleInstanceDataManager:GetCurrentModel():GetNotClaimedLevel()
    local currentLevelScore = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceScore()
    local showNotClaimLevel = notClaimedLevel~=0 and notClaimedLevel<(currentAchievement + 1)

    local targetLevel = showNotClaimLevel and notClaimedLevel or (currentAchievement + 1)

    if targetLevel >=  maxLevel then
        targetLevel = maxLevel
    end
    local rewardConfig = ConfigMgr.config_cy_instance_reward[CycleInstanceDataManager:GetCurrentModel().instance_id or 4][targetLevel]
    local currentLevelScoreMax = rewardConfig.experience
    currentLevelScore = showNotClaimLevel and currentLevelScoreMax or currentLevelScore
    ----提醒有里程碑奖励没有领取
    self:RefreshRewardAnim()
    --self:RefreshPackButton()

    --刷新礼包按钮
    self:RefreshPackButton()
end

---提醒有里程碑奖励没有领取
function CycleCastleMainViewUIView:RefreshRewardAnim()
    local rewardAnim = self:GetComp("Milestone/currentProg/reward","Animation")
    if rewardAnim then
        local needShowRewardAnim = CycleInstanceDataManager:GetCurrentModel():IsAnyRewardCanClaim()
        if needShowRewardAnim then
            rewardAnim:Play()
            self:GetGo("Milestone/currentProg/reward/vfx_charge_1"):SetActive(true)
            self:GetGo("Milestone/currentProg/reward/vfx_charge_2"):SetActive(true)
        else
            AnimationUtil.Reset(rewardAnim,"instance_charge")
            self:GetGo("Milestone/currentProg/reward/vfx_charge_1"):SetActive(false)
            self:GetGo("Milestone/currentProg/reward/vfx_charge_2"):SetActive(false)
        end
    end
end

function CycleCastleMainViewUIView:GetShowScoreAndShowMaxScore()
    local currentAchievement = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel()
    local maxLevel = CycleInstanceDataManager:GetCurrentModel():GetMaxAchievementLevel()

    local notClaimedLevel = CycleInstanceDataManager:GetCurrentModel():GetNotClaimedLevel()
    local notClaimedLevel = 0
    local showScore = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceScore()
    local showNotClaimLevel = notClaimedLevel~=0 and notClaimedLevel<(currentAchievement + 1)

    local targetLevel = showNotClaimLevel and notClaimedLevel or (currentAchievement + 1)

    if targetLevel >= maxLevel then
        targetLevel = maxLevel
    end
    local achievementConfig = CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[targetLevel]
    local showMaxScore = achievementConfig.condition
    showScore = showNotClaimLevel and showMaxScore or showScore

    return showScore,showMaxScore
end

function CycleCastleMainViewUIView:GetDebuffCount()
    local workers = CycleInstanceDataManager:GetCurrentModel().workerList
    local hungry,physical,debugWorker,allWorker = 0,0,0,0
    local stateThreshold = CycleInstanceDataManager.config_global.stateThreshold
    for k,v in pairs(workers) do
        if next(v) ~= nil then
            for _,furIndex in pairs(v) do
                local attrs = CycleInstanceDataManager:GetCurrentModel():GetWorkerAttr(k,furIndex)
                allWorker = allWorker + 1
                if attrs.hungry < stateThreshold or attrs.physical < stateThreshold  then
                    debugWorker = debugWorker + 1
                    if attrs.hungry < stateThreshold  then
                        hungry = hungry + 1
                    end
                    if attrs.physical < stateThreshold  then
                        physical = physical + 1
                    end
                end
            end
        end
    end

    return hungry,physical,debugWorker,allWorker
end

function CycleCastleMainViewUIView:GetMaxAchievementLevel()
    local config = CycleInstanceDataManager.config_achievement_instance
    local result = 0
    for k,v in pairs(config) do
        if v.level >= result then
            result = v.level
        end
    end
    return result
end


function CycleCastleMainViewUIView:SetAchievementActive(active)
    self:GetGo("Milestone"):SetActive(active)
    --self:GetGo("DetailPanel/SettingBtn"):SetActive(false)
    if active then
        self:RefreshRewardAnim()
    end
end

function CycleCastleMainViewUIView:SetEventActive(active)
    local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(14020)
    self:GetGo("EventArea"):SetActive(active and guide2IsComplete)
end

function CycleCastleMainViewUIView:SetEventIAAActive(active)
    self:GetGo("EventArea/IAA"):SetActive(active)
end

function CycleCastleMainViewUIView:SetPackActive(active)
    local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(14020)
    self:GetGo("BottomPanel/PackBtn"):SetActive(active and guide2IsComplete)
end

function CycleCastleMainViewUIView:RefreshPackButton()
    local giftsList = CycleInstanceDataManager:GetCurrentModel():GetActivePackList()
    local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(14020)
    local active = giftsList and next(giftsList) ~= nil
    self:SetPackActive(active and guide2IsComplete)
end

function CycleCastleMainViewUIView:GetRemainingTimeString()
    local state = CycleInstanceDataManager:GetInstanceState()
    local timeRemaining = 0
    if state == CycleInstanceDataManager.instanceState.isActive then
        timeRemaining = CycleInstanceDataManager:GetLeftInstanceTime()
    else
        GameTimer:StopTimer(self.packBtnTimer)
        self.packBtnTimer = nil
        return
    end
    local timeDate = GameTimeManager:GetTimeLengthDate(timeRemaining)
    local d = timeDate.d
    local h = timeDate.h + d * 24
    local m = timeDate.m
    local s = timeDate.s
    if h < 10 then h = "0"..h end
    if m < 10 then m = "0"..m end
    if s < 10 then s = "0"..s end
    local timeStr = string.format("%s:%s:%s",h,m,s)
    return timeStr
end

function CycleCastleMainViewUIView:RefreshShopButton()
    -- self:GetGo("BottomPanel/ShopBtn/icon"):SetActive(CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel())
    -- local isCanFreeGet = 
    -- self:GetGo
    local freeItemData = {}
    freeItemData.canUse = CycleInstanceDataManager:GetCurrentModel():CanGetFreeSlotCoin()
    freeItemData.amount = ConfigMgr.config_global.cycle_instance_freeCoinNum
    freeItemData.icon = ConfigMgr.config_global.cycle_instance_freeCoinIcon
    freeItemData.leftTimes = ConfigMgr.config_global.cycle_instance_freeCoinFre - CycleInstanceDataManager:GetCurrentModel():GetCurFreeSlotCoinTimes()
    self:GetGo("BottomPanel/ShopBtn/icon"):SetActive(freeItemData.canUse and freeItemData.leftTimes > 0)
end

function CycleCastleMainViewUIView:CheckLastOneDay()
    -- if not self.IsLastOneDay then
    --     if not self.CheckLastOneDayTimer then
    --         self.CheckLastOneDayTimer = GameTimer:CreateNewTimer(1, function()
    --             if CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel() then
    --                 self.IsLastOneDay = true
    --                 -- self:RefreshShopButton()
    --                 GameTimer:StopTimer(self.CheckLastOneDayTimer)
    --                 self.CheckLastOneDayTimer = nil
    --             end
    --         end, true, true)            
    --     end
    -- end
end

---播放动画前计算Slider的max,min,value
--function CycleCastleMainViewUIView:RefreshSlider()
--    local showScore,showMaxScore = self:GetShowScoreAndShowMaxScore()
--
--    local slider = self:GetComp("DetailPanel/milestone/currentProg/prog","Slider")
--    local curProgress = (slider.value-slider.minValue)/(slider.maxValue-slider.minValue)
--    local targetProgress = showScore/showMaxScore
--    --printf(string.format("curProgress/targetProgress = %.2f/%.2f",curProgress,targetProgress))
--    if targetProgress ~= curProgress then
--        local len = 1/(targetProgress-curProgress)
--        local min = -curProgress*(len)
--        local max = min+len
--        slider.maxValue = max
--        slider.minValue = min
--        slider.value = len * curProgress + min
--        return true
--    else
--        return false
--    end
--end

function CycleCastleMainViewUIView:RefreshMilestone()
    ----里程碑节点相关内容
    --local nextLevel = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel() + 1
    --local curLevel = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel()
    --if nextLevel > Tools:GetTableSize(CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward) then
    --    nextLevel = Tools:GetTableSize(CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward)
    --end
    --
    --local beforeScore = 0
    --if curLevel > 0 then
    --    beforeScore = CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[curLevel].experience
    --end
    --local curScore = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceScore()
    --local maxExp = CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[nextLevel].experience
    --local proValue = BigNumber:Divide(curScore,maxExp)
    --local icon = ConfigMgr.config_shop[CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[nextLevel].shop_id].icon
    --local shopID = CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[nextLevel].shop_id
    --if shopID then
    --    local shopCfg = ConfigMgr.config_shop[shopID]
    --    if shopCfg.type == 9 then
    --        if shopCfg.country == 0 then
    --            if GameTableDefine.CityMode:CheckBuildingSatisfy(700) then
    --                icon = icon.."_euro"
    --            end
    --        elseif shopCfg.country == 2 then
    --            icon = icon.."_euro"
    --        end
    --    end
    --end
    ----如果当前有没有领取的奖励的话显示未领取奖励的icon
    --local noClaimedRewards = CycleInstanceDataManager:GetCurrentModel():GetAllSKRewardNotClaim()
    --local rewardsSize = Tools:GetTableSize(noClaimedRewards)
    --if noClaimedRewards and rewardsSize > 0 then
    --    icon = ConfigMgr.config_shop[noClaimedRewards[rewardsSize].shop_id].icon
    --    local shopID = noClaimedRewards[rewardsSize].shop_id
    --    if shopID then
    --        local shopCfg = ConfigMgr.config_shop[shopID]
    --        if shopCfg.type == 9 then
    --            if shopCfg.country == 0 then
    --                if GameTableDefine.CityMode:CheckBuildingSatisfy(700) then
    --                    icon = icon.."_euro"
    --                end
    --            elseif shopCfg.country == 2 then
    --                icon = icon.."_euro"
    --            end
    --        end
    --    end
    --end
    --
    --self:SetText("Milestone/progLevel/progress", CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel())
    --self:SetText("Milestone/progLevel/limit", Tools:GetTableSize(CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward))
    --self:SetText("Milestone/currentProg/prog/progPoint/progress", BigNumber:FormatBigNumber(curScore))
    --self:SetText("Milestone/currentProg/prog/progPoint/limit", BigNumber:FormatBigNumber(maxExp))
    --
    --self:SetSprite(self:GetComp("Milestone/currentProg/reward/icon", "Image"), "UI_Shop", icon)
    --self:GetComp("Milestone/currentProg/prog", "Slider").value = tonumber(proValue)

    --里程碑信息栏
    local currentAchievement = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel()
    local maxLevel = CycleInstanceDataManager:GetCurrentModel():GetMaxAchievementLevel()

    local notClaimedLevel = CycleInstanceDataManager:GetCurrentModel():GetNotClaimedLevel()
    local currentLevelScore = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceScore()
    local showNotClaimLevel = notClaimedLevel ~= 0 and notClaimedLevel < (currentAchievement + 1)

    local targetLevel = showNotClaimLevel and notClaimedLevel or (currentAchievement + 1)
    if targetLevel >= maxLevel then
        targetLevel = maxLevel
    end
    local achievementConfig = CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[targetLevel]
    --local rewardConfig = CycleInstanceDataManager:GetCurrentModel().resourceConfig[achievementConfig.reward_id][1]
    local currentLevelScoreMax = achievementConfig.experience
    currentLevelScore = showNotClaimLevel and currentLevelScoreMax or currentLevelScore
    --local currentLevelScoreStr = Tools:SeparateNumberWithComma(currentLevelScore)
    --local currentLevelScoreMaxStr = Tools:SeparateNumberWithComma(currentLevelScoreMax)
    self:SetText("Milestone/currentProg/prog/progPoint/progress", BigNumber:FormatBigNumber(currentLevelScore))
    self:SetText("Milestone/currentProg/prog/progPoint/limit", BigNumber:FormatBigNumber(currentLevelScoreMax))

    local slider = self:GetComp("Milestone/currentProg/prog","Slider")
    slider.minValue = 0
    slider.maxValue = 1
    slider.value = currentLevelScore / currentLevelScoreMax
    local icon = ConfigMgr.config_shop[CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[targetLevel].shop_id].icon
    local shopID = CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[targetLevel].shop_id
    if shopID then
        local shopCfg = ConfigMgr.config_shop[shopID]
        if shopCfg.type == 9 then
            if shopCfg.country == 0 then
                if GameTableDefine.CityMode:CheckBuildingSatisfy(700) then
                    icon = icon.."_euro"
                end
            elseif shopCfg.country == 2 then
                icon = icon.."_euro"
            end
        end
    end
    self:SetSprite(self:GetComp("Milestone/currentProg/reward/icon", "Image"), "UI_Shop", icon)
    --self:GetComp("Milestone/currentProg/prog", "Slider").value = tonumber(proValue)
    self:SetButtonClickHandler(self:GetComp("Milestone/currentProg/reward", "Button"), function()

        local currentModel = CycleInstanceDataManager:GetCurrentModel()
        local rewards = currentModel:GetRewardByLevel(targetLevel)
        if rewards and next(rewards) ~= nil then
            local getFlag, dispRewards = currentModel:RealGetRewardByLevel(targetLevel)
            if getFlag then
                GameTableDefine.CycleCastleRewardUI:ShowGetReward(rewards)
                GameTableDefine.CycleCastleMainViewUI:Refresh()
            end
        end
    end)
    self:GetGo("Milestone/currentProg/prog/vfx_max"):SetActive(targetLevel <= currentAchievement)
    self:SetText("Milestone/progLevel/progress", CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel())
    self:SetText("Milestone/progLevel/limit", Tools:GetTableSize(CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward))
    self:CheckMilestoneGuide()
end

--检查是否应该开启里程碑引导
function CycleCastleMainViewUIView:CheckMilestoneGuide()
    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    --1.是否开启过引导
    if currentModel:IsGuideCompleted(14020) then
        return false
    end
    --2.是否有奖励可领取
    local noClaimedRewards = currentModel:GetAllSKRewardNotClaim()
    if not noClaimedRewards or #noClaimedRewards == 0 then
        return false
    end
    --3.是否可操作状态
    if not GameUIManager:GetEnableTouch() then
        return false
    end
    --4.是否位于主界面
    if not GameUIManager:UIIsOnTop(ENUM_GAME_UITYPE.CYCLE_CASTLE_MAIN_VIEW_UI,true) then
        return false
    end
    --5.是否在播放TimeLine
    if currentModel:GetScene():IsPlayingTimeLine() then
        return false
    end
    --6.是否在转场云层
    if GameUIManager:IsUIOpen(ENUM_GAME_UITYPE.CYCLE_CASTLE_CUT_SCREEN_UI) then
        return false
    end

    --5.条件都满足，开启引导.
    GuideManager.currStep = 14020
    GuideManager:ConditionToStart()
    currentModel:SetGuideCompleted(14020)
    return true
end

---播放里程碑分数奖励动画
function CycleCastleMainViewUIView:PlayMilestoneAnim()
    self:RefreshMilestone()
    local fb = self:GetComp("Milestone/currentProg/prog/Fill Area/Fill/vfx/fb","MMFeedbacks")
    fb:PlayFeedbacks()
end

function CycleCastleMainViewUIView:OpenTestResWatch()
    if self.testResWatchTimer then
        GameTimer:StopTimer(self.testResWatchTimer)
        self.testResWatchTimer = nil
    end
    --self.testResWatchTimer = GameTimer:CreateNewTimer(1, function()
    --    --1、钞票总量
    --    --2、钞票产出效率
    --    --3、经验书总量
    --    --4、经验书产出效率
    --    --5、扭蛋币总量
    --    --6、里程碑积分
    --    local totalCoin = math.floor(CycleInstanceDataManager:GetCurrentModel():GetCurInstanceCoin())
    --    local _, tmpSpwanCoin = CycleInstanceDataManager:GetCurrentModel():CalculateOfflineRewards(60)
    --    local spawnCoin = math.floor(tmpSpwanCoin)
    --    local heroUpExp = CycleInstanceDataManager:GetCurrentModel():GetCurHeroExpRes()
    --    local spwanHeroUpExp = math.floor(CycleInstanceDataManager:GetCurrentModel():GetExpOutputPerMin())
    --    local slotCoin = CycleInstanceDataManager:GetCurrentModel():GetCurSlotCoin()
    --    local mileCoin = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceScore()
    --    self:SetText("ResourceBG/Res_Line/cash/num", BigNumber:FormatBigNumber(totalCoin))
    --    self:SetText("ResourceBG/Res_Line/cash_min/num", BigNumber:FormatBigNumber(spawnCoin).."/min")
    --    self:SetText("ResourceBG/Res_Line/hero/num", BigNumber:FormatBigNumber(heroUpExp))
    --    self:SetText("ResourceBG/Res_Line/hero_min/num", BigNumber:FormatBigNumber(spwanHeroUpExp).."/min")
    --    self:SetText("ResourceBG/Res_Line/coin/num", Tools:SeparateNumberWithComma(slotCoin))
    --    self:SetText("ResourceBG/Res_Line/point/num", BigNumber:FormatBigNumber(mileCoin))
    --end, true, true)
end

function CycleCastleMainViewUIView:CloseTestResWatch()
    if self.testResWatchTimer then
        GameTimer:StopTimer(self.testResWatchTimer)
        self.testResWatchTimer = nil
    end
end

---定时刷新任务状态
function CycleCastleMainViewUIView:StartRefreshButtonTips()
    if self.m_refreshTaskTimer then
        return
    end
    local taskTipGO = self:GetGo("BottomPanel/TaskBtn/icon")
    local slotMachineTipGO = self:GetGo("BottomPanel/SlotBtn/icon")
    local skillTipGo = self:GetGo("BottomPanel/SkillBtn/icon")
    self.m_refreshTaskTimer = GameTimer:CreateNewTimer(1,function()
        local currentModel = CycleInstanceDataManager:GetCurrentModel()
        taskTipGO:SetActive(CycleCastleTaskManager:UpdateTaskState(true))
        local canSlot = currentModel:GetCurSlotCoin()>=5
        slotMachineTipGO:SetActive(canSlot)
        skillTipGo:SetActive(currentModel:CheckSkillCanUpdate())

        self:RefreshShopButton()
    end,true,true)
end

---播放副本故事TimeLine时隐藏CycleMainUI
---@param isPlay boolean -等于true播放显示动画，等于false隐藏
function CycleCastleMainViewUIView:GuideTimeUIState(isPlay)
    local animation = self.m_uiObj:GetComponent("Animation")
    animation.enabled = true
    if isPlay then
        AnimationUtil.Play(animation, "UI_transfer_instace", nil, 1, "KEY_FRAME_ANIM_END")
    else
        AnimationUtil.GotoAndStop(animation, "UI_transfer_instace", "KEY_FRAME_ANIM_END")
    end
end

function CycleCastleMainViewUIView:PlayCloseGiftAnima()
    local animation = self:GetComp("BottomPanel/PackBtn/pack_Fly", "Animation")
    AnimationUtil.Play(animation, "Instance2_pack_Fly_Anim", nil, 1)
end

---引导完成解锁UI界面
function CycleCastleMainViewUIView:RefreshUIEntryByGuideState()
    --是否完成引导2
    local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(14020)
    self:GetGo("BottomPanel/SlotBtn"):SetActive(guide2IsComplete)
    self:GetGo("BottomPanel/ShopBtn"):SetActive(guide2IsComplete)
    self:GetGo("BottomPanel/PackBtn"):SetActive(guide2IsComplete)
    self:GetGo("BottomPanel/TaskBtn"):SetActive(guide2IsComplete)
    self:GetGo("EventArea"):SetActive(guide2IsComplete)

    --是否完成引导3
    local guide3IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(14050)
    self:GetGo("BottomPanel/SellBtn"):SetActive(guide3IsComplete)
    self:GetGo("BottomPanel/SkillBtn"):SetActive(guide3IsComplete)
end

return CycleCastleMainViewUIView