---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2024/6/26 19:42
---

---@class CycleNightClubHeroManager
local CycleNightClubHeroManager = GameTableDefine.CycleNightClubHeroManager
--local HERO_DATA_KEY = "CycleIslandHero"
local ConfigMgr = GameTableDefine.ConfigMgr
local CycleInstanceDataManager = GameTableDefine.CycleInstanceDataManager

---@type HeroData
---@field level number
---@field heroID string
local HeroData = {}

---@type ConfigCyInstanceHero
---@field buff number
---@field half_icon string
---@field icon string
---@field id number
---@field level number
---@field name string
---@field res string
---@field room_id number
local ConfigCyInstanceHero = {}

---@type HeroUpgradeResult
CycleNightClubHeroManager.HeroUpgradeResult = {
    Success = 1,
    ResNotEnough = 2,
    LevelMax = 3,
    CannotFindHeroConfig = 4
}

function CycleNightClubHeroManager:ctor()
    self.m_isInitialized = false
    self.m_heroDatas = nil ---@type HeroData
    self.m_heroConfigs = nil ---@type table<number,ConfigCyInstanceHero[]>
end

---副本重开时，重置数据
function CycleNightClubHeroManager:Reset()
    self.m_isInitialized = false
end

function CycleNightClubHeroManager:Init()
    if self.m_isInitialized then
        return
    end
    self.m_isInitialized = true
    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    self.m_heroDatas = currentModel:GetHeroSaveData()
    self.m_heroConfigs = ConfigMgr.config_cy_instance_hero[currentModel.instance_id]
    if not self.m_heroConfigs then
        printError("加载英雄(配方)配置表失败，instanceID = "..(currentModel.instance_id or -1))
    end
end

---根据英雄ID和等级 返回配置
---@return ConfigCyInstanceHero
function CycleNightClubHeroManager:GetHeroConfig(heroID,level)
    self:Init()
    if self.m_heroConfigs and heroID then
        local heroConfigs = self.m_heroConfigs[heroID]
        if heroConfigs then
            local result = heroConfigs[level]
            if result then
                return result
            end
        end
    end
    printError("找不到英雄配置 heroID:"..heroID.." ,Level:"..level)
    return nil
end

---根据英雄ID 获取buff值
---@return ConfigCyInstanceHero
function CycleNightClubHeroManager:GetHeroCurrentBuff(heroID)
    local heroData = self:GetHeroData(heroID)
    local level = heroData.level
    local heroConfig = self:GetHeroConfig(heroID,level)
    if heroConfig then
        return heroConfig.buff or 1
    else
        printError("无法获取英雄(配方)buff值 heroID = "..(heroID or "nil"))
        return 1
    end
end

---返回对应英雄的存档数据
---@return HeroData
function CycleNightClubHeroManager:GetHeroData(heroID)
    self:Init()
    local heroData = self.m_heroDatas[heroID]
    if not heroData then
        heroData = {}
        heroData.level = 1
        heroData.heroID = heroID
        self.m_heroDatas[heroID] = heroData
    end
    return heroData
end

---给英雄升级,并消耗材料
---@param heroID string
---@return boolean,ConfigCyInstanceHero
function CycleNightClubHeroManager:UpgradeHero(heroID)
    self:Init()
    local heroData = self:GetHeroData(heroID)
    local curLevelConfig = self:GetHeroConfig(heroID,heroData.level)
    local nextLevelConfig = self:GetHeroConfig(heroID,heroData.level+1)
    ---上传英雄升级埋点，每5级上传一次
    if heroData.level % 5 == 0 then
        GameSDKs:TrackForeign("cy_hero_upgrade", { id = heroID, level = tonumber(heroData.level)})
    end
    if not curLevelConfig then
        error("没找到英雄配置")
        return CycleNightClubHeroManager.HeroUpgradeResult.CannotFindHeroConfig,nil
    end
    --判断是否有下一级的配置
    if nextLevelConfig then
        local requireRes = curLevelConfig.res
        if CycleInstanceDataManager:GetCurrentModel():ChangeCurHeroExpRes("-"..requireRes) then
            heroData.level = heroData.level + 1
            return CycleNightClubHeroManager.HeroUpgradeResult.Success,nextLevelConfig
        else
            return CycleNightClubHeroManager.HeroUpgradeResult.ResNotEnough,nil
        end
    end
    return CycleNightClubHeroManager.HeroUpgradeResult.LevelMax,nil
end

---判断是否满级
function CycleNightClubHeroManager:IsMaxLevel(heroID)
    self:Init()
    local heroData = self:GetHeroData(heroID)
    local nextLevel = heroData.level + 1

    local heroConfigs = self.m_heroConfigs[heroID]
    if heroConfigs then
        local result = heroConfigs[nextLevel]
        if result then
            return false
        end
        return true
    end
    return true
end

---是否可以升级
---@return boolean
function CycleNightClubHeroManager:CanUpgrade(heroID)
    self:Init()
    local heroData = self:GetHeroData(heroID)
    local curLevelConfig = self:GetHeroConfig(heroID,heroData.level)
    local nextLevelConfig = self:GetHeroConfig(heroID,heroData.level+1)

    if not curLevelConfig then
        error("没找到英雄配置")
        return false
    end
    --判断是否有下一级的配置
    if nextLevelConfig then
        local requireRes = tostring(curLevelConfig.res)
        local haveRes = CycleInstanceDataManager:GetCurrentModel():GetCurHeroExpRes()
        if BigNumber:CompareBig(haveRes,requireRes) or haveRes == requireRes then
            return true
        else
            return false
        end
    end
    return false
end

function CycleNightClubHeroManager:GetHeroMaxLevel(id)
    return 300
end

return CycleNightClubHeroManager