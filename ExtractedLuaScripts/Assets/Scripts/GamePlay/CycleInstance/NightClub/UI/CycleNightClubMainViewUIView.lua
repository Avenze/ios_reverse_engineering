---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2024/6/28 15:00
---

local Class = require("Framework.Lua.Class")
local UIView = require("Framework.UI.View")
local EventManager = require("Framework.Event.Manager")
local ViewUtils = require("GamePlay.Utils.ViewUtils")
local GameResMgr = require("GameUtils.GameResManager")
local CycleInstanceDefine = require("GamePlay.CycleInstance.CycleInstanceDefine")

local FileHelper = CS.Common.Utils.FileHelper
local AnimationUtil = CS.Common.Utils.AnimationUtil
local UnityHelper = CS.Common.Utils.UnityHelper
local Color = CS.UnityEngine.Color
local GameObject = CS.UnityEngine.GameObject
local Vector3 = CS.UnityEngine.Vector3

local CycleInstanceDataManager = GameTableDefine.CycleInstanceDataManager
local ResourceManger = GameTableDefine.ResourceManger
local ConfigMgr = GameTableDefine.ConfigMgr
local SettingUI = GameTableDefine.SettingUI
--local InstanceMilepostUI = GameTableDefine.InstanceMilepostUI
local InstanceProcessUI = GameTableDefine.InstanceProcessUI
--local CycleIslandTimeUI = GameTableDefine.CycleIslandTimeUI
local CycleNightClubShopUI = GameTableDefine.CycleNightClubShopUI
--local InstanceAdUI = GameTableDefine.InstanceAdUI
local CycleNightClubTaskManager = GameTableDefine.CycleNightClubTaskManager
--local InstanceUnlockUI = GameTableDefine.InstanceUnlockUI
--local InstanceBuildingUI = GameTableDefine.InstanceBuildingUI
local GameUIManager = GameTableDefine.GameUIManager
local CycleNightClubTaskUI = GameTableDefine.CycleNightClubTaskUI
local CycleNightClubSlotMachineUI = GameTableDefine.CycleNightClubSlotMachineUI
local CycleNightClubSkillUI = GameTableDefine.CycleNightClubSkillUI
local CycleNightClubMilepostUI = GameTableDefine.CycleNightClubMilepostUI
local CycleNightClubPopUI = GameTableDefine.CycleNightClubPopUI
local CycleNightClubSellUI = GameTableDefine.CycleNightClubSellUI
local ShopManager = GameTableDefine.ShopManager
local SoundEngine = GameTableDefine.SoundEngine
local GuideManager = GameTableDefine.GuideManager
local CycleNightClubRewardUI = GameTableDefine.CycleNightClubRewardUI
local CycleNightClubAdUI = GameTableDefine.CycleNightClubAdUI
local CycleNightClubBlueprintUI = GameTableDefine.CycleNightClubBlueprintUI

local CycleNightClubRankUI = GameTableDefine.CycleNightClubRankUI
local CycleNightClubPiggyBankUI = GameTableDefine.CycleNightClubPiggyBankUI
local EventDispatcher = EventDispatcher

---@class CycleNightClubMainViewUIView:UIBaseView
local CycleNightClubMainViewUIView = Class("CycleNightClubMainViewUIView", UIView)
local notifyPopLength = 10  --通知气泡数量上线
local currentNotifyCount = 0
local employeeNotify = nil
local moneyNotify = nil
local milestoneNotify = nil
local notifyList = {}

function CycleNightClubMainViewUIView:ctor()
    self.super:ctor()
    self.m_data = {}

    self.m_milestoneAnimation = nil ---@type UnityEngine.Animation

    --self.m_openSellUIBtn = nil ---@type UnityEngine.UI.Button

    self.m_taskDoneGO = nil ---@type UnityEngine.GameObject
    self.m_mileProgressText = nil ---@type UnityEngine.UI.Text
    self.m_mileLimitText = nil ---@type UnityEngine.UI.Text
    self.m_mileSlider = nil ---@type UnityEngine.UI.Slider
    self.m_mileRewardIcon = nil ---@type UnityEngine.UI.Image
    self.m_mileRewardBtn = nil ---@type UnityEngine.UI.Button
    self.m_mileVfxGO = nil ---@type UnityEngine.GameObject
    self.m_mileCurLevelText = nil ---@type UnityEngine.UI.Text
    self.m_mileMaxLevelText = nil ---@type UnityEngine.UI.Text

    self.m_blueprintBtn = nil ---@type UnityEngine.UI.Button

    self.m_piggyBankGO = nil ---小猪
    self.m_piggyBankRedPointGO = nil ---小猪红点
    self.m_piggyBankSlider = nil ---小猪进度条
    self.m_piggyBankCurValueText = nil ---小猪进度当前数值
    self.m_piggyBankMaxValueText = nil ---小猪进度达标数值
end

function CycleNightClubMainViewUIView:Exit()
    local txt = GameTextLoader:ReadText("TXT_INSTANCE_TIP_RETURN")
    GameTableDefine.ChooseUI:CommonChoose(txt, function()
        if GameTableDefine.CycleNightClubRankManager:ReportCheck() then
            GameTableDefine.CycleNightClubRankManager:ReportRank()
        end

        self:DestroyModeUIObject()
    end, true, nil)
end

function CycleNightClubMainViewUIView:OnEnter()

    self.m_mileProgressText = self:GetComp("Milestone/currentProg/prog/progPoint/progress","TMPLocalization")
    self.m_mileLimitText = self:GetComp("Milestone/currentProg/prog/progPoint/limit","TMPLocalization")
    self.m_mileSlider = self:GetComp("Milestone/currentProg/prog","Slider")
    self.m_mileRewardIcon = self:GetComp("Milestone/currentProg/reward/icon", "Image")
    self.m_mileRewardBtn = self:GetComp("Milestone/currentProg/reward", "Button")
    self.m_mileVfxGO = self:GetGo("Milestone/currentProg/prog/vfx_max")
    self.m_mileCurLevelText = self:GetComp("Milestone/progLevel/progress","TMPLocalization")
    self.m_mileMaxLevelText = self:GetComp("Milestone/progLevel/limit","TMPLocalization")


    local timeType1 = self:GetGo("ResourceBG/CurrTimeFrame/1")
    local timeType2 = self:GetGo("ResourceBG/CurrTimeFrame/2")
    local timeType3 = self:GetGo("ResourceBG/CurrTimeFrame/3")
    self.timeTypeUI = {
        [1] = timeType1,
        [2] = timeType2,
        [3] = timeType3
    }
    self.m_moneyText = self:GetComp("ResourceBG/MoneyInterface/num","TMPLocalization")
    self.m_diamondText = self:GetComp("ResourceBG/DiamondInterface/num","TMPLocalization")
    self.m_milestoneAnimation = self:GetComp("Milestone/currentProg/reward","Animation")
    self.m_milestoneVfx1GO = self:GetGo("Milestone/currentProg/reward/vfx_charge_1")
    self.m_milestoneVfx2GO = self:GetGo("Milestone/currentProg/reward/vfx_charge_2")

    self.m_milestoneTimerText = self:GetComp("Milestone/timer/num","TMPLocalization")

    do
        --第一次打开后不再自动播放开启动画
        local animation = self.m_uiObj:GetComponent("Animation")
        animation.playAutomatically = false
    end
    --测试显示当前资源产出数量的UI
    self:OpenTestResWatch()
    if self.curInstanceTimer then
        GameTimer:StopTimer(self.curInstanceTimer)
        self.curInstanceTimer = nil
    end
    self:SetText("Milestone/progLevel/progress", CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel())
    self:SetText("Milestone/progLevel/limit", Tools:GetTableSize(CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward))
    --返回主场景
    self:SetButtonClickHandler(self:GetComp("ReturnBtn","Button"), function()
        self:Exit()
    end)
    --设置按钮
    --local settingGo = self:GetGoOrNil("DetailPanel/SettingBtn")
    --if settingGo then
    --    settingGo:SetActive(false)
    --end
    --self:SetButtonClickHandler(self:GetComp("DetailPanel/SettingBtn","Button"),function()
    --    -- SettingUI:GetView()
    --    -- local curLevel = InstanceDataManager:GetCurInstanceKSLevel()
    --    -- InstanceDataManager:SetCurInstanceKSLevel(curLevel + 1)
    --end)
    --打开商店按钮
    self.m_shopBtn = self:GetComp("BottomPanel/ShopBtn","Button")
    self:SetButtonClickHandler(self.m_shopBtn,function()
        CycleNightClubShopUI:GetView()
    end)
    self.m_shopBtnRedPoint = self:GetGo("BottomPanel/ShopBtn/icon")
    --打开生产线界面
    self:SetButtonClickHandler(self:GetComp("BottomPanel/ProductBtn","Button"),function()
        InstanceProcessUI:ShowView()
    end)

    --时间按钮
    --self:SetButtonClickHandler(self:GetComp("ResourceBG/CurrTimeFrame","Button"),function()
    --    CycleIslandTimeUI:GetView()
    --end)
    --里程碑按钮
    --self:SetButtonClickHandler(self:GetComp("DetailPanel/milestone/milestoneBtn","Button"),function()
    --    InstanceMilepostUI:OpenUI()
    --end)
    --任务按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/TaskBtn","Button"),function()
        CycleNightClubTaskUI:OpenView()
    end)

    --拉霸机按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/SlotBtn","Button"),function()
        CycleNightClubSlotMachineUI:OpenView(CycleInstanceDataManager:GetCurrentModel().instance_id or 1)
        -- GameSDKs:TrackForeign("button_event", { slot_btn = 1})
    end)

    --技能面板按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/SkillBtn", "Button"), function()
        CycleNightClubSkillUI:ShowSkillPanel()
    end)

    --里程碑界面入口设置
    self:SetButtonClickHandler(self:GetComp("Milestone", "Button"), function()
        local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone)
        if guide2IsComplete then
            CycleNightClubMilepostUI:ShowMilepostPanel()
        end
    end)

    --礼包按钮
    self.m_packBtn = self:GetComp("BottomPanel/PackBtn", "Button")
    self:SetButtonClickHandler(self.m_packBtn, function()
        CycleNightClubPopUI:OpenView()
    end)

    --港口按钮
    self:SetButtonClickHandler(self:GetComp("BottomPanel/SellBtn", "Button"), function()
        --GameUIManager:SetEnableTouch(false)
        --local sellsID = CycleInstanceDataManager:GetCurrentModel():GetRoomDataByType(4)
        --local sellID = sellsID[1].roomID
        --CycleInstanceDataManager:GetCurrentModel():GetScene():LookAtSceneGO(sellID,nil,nil,nil,function()
        --    CycleNightClubSellUI:ShowWharfUI(sellID)
        --    GameUIManager:SetEnableTouch(true)
        --end)
    end)
    --充值钻石按钮
    self:SetButtonClickHandler(self:GetComp("ResourceBG/DiamondInterface/AddBtn", "Button"), function()
        CycleNightClubShopUI:OpenAndTurnPage(1000)
    end)

    -- 不显示蓝图
    self.m_blueprintBtn = self:GetComp("BottomPanel/BlueprintBtn","Button")
    --self:GetComp("BottomPanel/BlueprintBtn","Animator").enabled = false
    --蓝图按钮
    self:SetButtonClickHandler(self.m_blueprintBtn,function()
        CycleNightClubBlueprintUI:OpenView()
    end)

    --点击工人按钮
    self:SetButtonClickHandler(self:GetComp("ResourceBG/EmployeeInterface","Button"),function()
        self:GetGo("HelpInfo_employee"):SetActive(true)
        local hungry,physical,debugWorker = self:GetDebuffCount()
        --state
        self:GetGo("HelpInfo_employee/frame/state/info/hunger"):SetActive(hungry > 0)
        self:GetGo("HelpInfo_employee/frame/state/info/physical"):SetActive(physical > 0)
        self:SetText("HelpInfo_employee/frame/state/info/hunger/num",hungry)
        self:SetText("HelpInfo_employee/frame/state/info/physical/num",physical)
        --desc
        self:GetGo("HelpInfo_employee/frame/desc/hunger"):SetActive(hungry > 0)
        self:GetGo("HelpInfo_employee/frame/desc/physical"):SetActive(physical > 0)
        local hungryStr1 = GameTextLoader:ReadText("TXT_INSTANCE_TIP_HUNGER")
        local hungryStr = string.gsub(hungryStr1,"{0}",tostring(hungry))
        local physicalStr1 = GameTextLoader:ReadText("TXT_INSTANCE_TIP_PHYSICAL")
        local physicalStr = string.gsub(physicalStr1,"{0}",tostring(physical))
        self:SetText("HelpInfo_employee/frame/desc/hunger",hungryStr)
        self:SetText("HelpInfo_employee/frame/desc/physical",physicalStr)
    end)

    --EventInstance按钮
    self:SetButtonClickHandler(self:GetComp("EventArea/IAA","Button"),function() 
        CycleNightClubAdUI:GetView()
    end)

    self:SetButtonClickHandler(self.m_mileRewardBtn, function()
        local currentModel = CycleInstanceDataManager:GetCurrentModel()
        local currentAchievement = currentModel:GetCurInstanceKSLevel()
        local maxLevel = currentModel:GetMaxAchievementLevel()

        local notClaimedLevel = currentModel:GetNotClaimedLevel()
        local showNotClaimLevel = notClaimedLevel ~= 0 and notClaimedLevel < (currentAchievement + 1)

        local targetLevel = showNotClaimLevel and notClaimedLevel or (currentAchievement + 1)
        if targetLevel >= maxLevel then
            targetLevel = maxLevel
        end
        local rewards = currentModel:GetRewardByLevel(targetLevel)
        if rewards and next(rewards) ~= nil then
            local getFlag, dispRewards = currentModel:RealGetRewardByLevel(targetLevel)
            if getFlag then
                if dispRewards then
                    CycleNightClubRewardUI:ShowGetReward(dispRewards)
                else
                    CycleNightClubRewardUI:ShowGetReward(rewards)
                end
                self:Show()
            end
        end
    end)

    self:InitView()

    self.curInstanceTimer = GameTimer:CreateNewTimer(1, function()
        self:UpdateOnSecond()
    end, true, true)

    if not CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockedSecondCycle) then
        self.m_secondGuideCheckTimer = GameTimer:CreateNewTimer(3,function()
            if GameUIManager:GetEnableTouch() and GameUIManager:UIIsOnTop(self.m_uiType,true) then
                --第二循环引导
                if self:CheckSecondCycleGuide() then
                    GameTimer:StopTimer(self.m_secondGuideCheckTimer)
                    self.m_secondGuideCheckTimer = nil
                end
            end
        end,true)
    end

    --region 排行榜
    self:SetButtonClickHandler(self:GetComp("ActivityPanel/RankAct", "Button"),function()
        GameSDKs:TrackForeign("button_event", { cy_rank = 1 })
        CycleNightClubRankUI:GetView()
    end)

    self:GetGo("ActivityPanel/RankAct"):SetActive(false)
    EventManager:RegEvent(GameEventDefine.RefreshNightClubRankNum, function()
        self:RefreshRankNum()
    end)

    EventDispatcher:RegEvent("RANK_ANIM_END", function()
        local vfx_obj = self:GetGoOrNil("ActivityPanel/RankAct/vfx_levelup")
        if vfx_obj then
            vfx_obj:SetActive(false)
        end
    end)
    
    GameTableDefine.CycleNightClubRankManager:EnterCycleNightClubInstanceMainUI()
    --endregion

    -- 小猪
    self.m_piggyBankGO = self:GetGo("ActivityPanel/PiggyBtn")
    self.m_piggyBankRedPointGO = self:GetGo("ActivityPanel/PiggyBtn/icon")
    self.m_piggyBankSlider = self:GetComp("ActivityPanel/PiggyBtn/Slider", "Slider")
    self.m_piggyBankCurValueText = self:GetComp("ActivityPanel/PiggyBtn/Slider/txt/txt1", "TMPLocalization")
    self.m_piggyBankMaxValueText = self:GetComp("ActivityPanel/PiggyBtn/Slider/txt/txt3", "TMPLocalization")

    self:RefreshPiggyBank()
    self:SetButtonClickHandler(self:GetComp("ActivityPanel/PiggyBtn", "Button"),function()
        GameSDKs:TrackForeign("button_event", { cy_piggy = 1 })
        CycleNightClubPiggyBankUI:GetView()
    end)

end

function CycleNightClubMainViewUIView:OnResume()
    self:CheckRankNum()
end

---检查排名是否有变化
function CycleNightClubMainViewUIView:CheckRankNum()
    local rank_num = GameTableDefine.CycleNightClubRankManager:GetUserRankNum()
    if not rank_num or rank_num <= 0 then
        self:GetGo("ActivityPanel/RankAct/vfx_levelup"):SetActive(false)
        return
    end

    if not self.rank_num then
        self.rank_num = rank_num
    end

    if self.rank_num > rank_num then
        self:GetGo("ActivityPanel/RankAct/vfx_levelup"):SetActive(false)
        self:SetText("ActivityPanel/RankAct/vfx_levelup/num", "+" .. tostring(self.rank_num - rank_num))
        self:GetGo("ActivityPanel/RankAct/vfx_levelup"):SetActive(true)
        self.rank_num = rank_num
    end
end

---刷新排行榜名次
function CycleNightClubMainViewUIView:RefreshRankNum()
    local rank_num = GameTableDefine.CycleNightClubRankManager:GetUserRankNum()
    if not rank_num or rank_num <= 0 then
        self:GetGo("ActivityPanel/RankAct"):SetActive(false)
        return
    end

   self:CheckRankNum()
    
    local rank_num_trans = self:GetTrans("ActivityPanel/RankAct/rank")
    local first_letter = string.sub(tostring(rank_num), 1, 1)
    local second_letter = string.sub(tostring(rank_num), 2, 2)

    for i = 0, rank_num_trans.childCount - 1 do
        local child = rank_num_trans:GetChild(i)
        for j = 0, child.childCount - 1 do
            child:GetChild(j).gameObject:SetActive(false)
        end

        child.gameObject:SetActive(false)
    end

    if first_letter and first_letter ~= "" then
        local first_letter_parent = rank_num_trans:GetChild(0).gameObject
        first_letter_parent:SetActive(true)
        self:GetGo(first_letter_parent, first_letter):SetActive(true)
    end

    if second_letter and second_letter ~= "" then
        local second_letter_parent = rank_num_trans:GetChild(1).gameObject
        second_letter_parent:SetActive(true)
        self:GetGo(second_letter_parent, second_letter):SetActive(true)
    end
    
    self:GetGo("ActivityPanel/RankAct"):SetActive(true)
end

---主界面额外的需要秒刷的
function CycleNightClubMainViewUIView:UpdateMainViewOnSecond()
    --英雄经验
    local heroExpStr = CycleInstanceDataManager:GetCurrentModel():GetCurHeroExpResShow()
    self:SetText("ResourceBG/ExpInterface/num", heroExpStr)
end

---一秒一次的副本主界面刷新
function CycleNightClubMainViewUIView:UpdateOnSecond()
    local timeRemaining = 0
    local state = CycleInstanceDataManager:GetInstanceState()
    if state == CycleInstanceDataManager.instanceState.isActive then
        timeRemaining = CycleInstanceDataManager:GetLeftInstanceTime()
    else
        --副本结束后持续显示为0
        timeRemaining = 0
    end
    -- local h = os.date("%d", timeRemaining) * 24 + os.date("%H", timeRemaining)
    -- local m = os.date("%M", timeRemaining)
    local timeStr =  GameTimeManager:FormatTimeLength(timeRemaining)
    self.m_milestoneTimerText.text = timeStr
    --里程碑节点
    self:RefreshMilestone()
    
    -- 额外的需要秒刷的
    self:UpdateMainViewOnSecond()
    --码头红点
    --local currentModel = CycleInstanceDataManager:GetCurrentModel()
    --local haveProductCanSellOrUpgrade = currentModel:HaveProductCanSale()
    --if not haveProductCanSellOrUpgrade then
    --    haveProductCanSellOrUpgrade = currentModel:IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockBluePrint) and GameTableDefine.CycleNightClubBluePrintManager:CanUpgradeAnyProduction()
    --end
    --self:GetGo("BottomPanel/SellBtn/icon"):SetActive(haveProductCanSellOrUpgrade)


    --收入
    local income = CycleInstanceDataManager:GetCurrentModel():GetRewardInComePerMinute() * 0.5
    self:SetText("ResourceBG/total/num", BigNumber:FormatBigNumber(income).."/30S")
end

function CycleNightClubMainViewUIView:OnExit()
    EventManager:UnregEvent(GameEventDefine.RefreshNightClubRankNum)
    EventDispatcher:UnRegEvent("RANK_ANIM_END")
    
    if self.timer then
        GameTimer:_RemoveTimer(self.timer)
    end
    if self.curInstanceTimer then
        GameTimer:StopTimer(self.curInstanceTimer)
        self.curInstanceTimer = nil
    end
    if self.m_refreshTaskTimer then
        GameTimer:StopTimer(self.m_refreshTaskTimer)
        self.m_refreshTaskTimer = nil
    end
    if self.m_secondGuideCheckTimer then
        GameTimer:StopTimer(self.m_secondGuideCheckTimer)
        self.m_secondGuideCheckTimer = nil
    end
    self:CloseTestResWatch()

    -- 排行榜新增事件
    if self.rank_timer then
        GameTimer:StopTimer(self.rank_timer)
    end

	self.super:OnExit(self)
end

function CycleNightClubMainViewUIView:InitView()
    self:Show()
    self:CheckLastOneDay()
    self.timer = GameTimer:CreateNewTimer(0.5,function()
        local curTime = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceTime(CycleInstanceDataManager:GetCurrentModel().instance_id or 4)
        local hStr = curTime.Hour
        if curTime.Hour < 10 then
            hStr = "0"..curTime.Hour
        end
        local mStr = curTime.Min
        if curTime.Min < 10 then
            mStr = "0"..curTime.Min
        end
        self:SetText("ResourceBG/CurrTimeFrame/CurrTime",string.format("%s:%s",hStr,mStr))
        --local isDay = InstanceModel:IsDay()
        --self:GetGo("ResourceBG/CurrTimeFrame/icon_day"):SetActive(isDay)
        --self:GetGo("ResourceBG/CurrTimeFrame/icon_night"):SetActive(not isDay)
        local curTimeType = CycleInstanceDataManager:GetCurrentModel().timeType
        for i = 1, 3 do
            self.timeTypeUI[i]:SetActive(i == curTimeType)
        end

        --local timeRemaining = CycleInstanceDataManager:GetLeftInstanceTime()
        --local h = math.floor( timeRemaining / 3600 )
        --local m = math.floor( timeRemaining % 86400 % 3600 /60 )

        --local timeStr =  string.format("%dh%dm", h,m)
        --self:SetText("DetailPanel/milestone/timer/num",timeStr)

        self:RefreshPackButton()

    end,true,true)

    -- 刷新排行榜剩余时间
    self.rank_timer = GameTimer:CreateNewTimer(1, function()
        local remain_time = GameTableDefine.CycleNightClubRankManager:GetRemainTime() -- 活动剩余时间转换
        if remain_time >= 0 then
            self:SetText("ActivityPanel/RankAct/time", Tools:FormatTime(remain_time))
        else
            if self.rank_timer then
                GameTimer:StopTimer(self.rank_timer)
                self.rank_timer = nil
            end
        end
    end, true, true)

    --初始化通知弹窗
    self:InitNotifyPop(notifyPopLength)
    --开启按钮状态的刷新
    self:StartRefreshButtonTips()
    self:RefreshUIEntryByGuideState()
end


function CycleNightClubMainViewUIView:InitNotifyPop(length)
    employeeNotify = self:GetGo("Notify/employee")
    moneyNotify = self:GetGo("Notify/money")
    milestoneNotify = self:GetGo("Notify/milestone")
end

--[[
    @desc: 
    author:{author}
    time:2023-05-10 15:37:12
    --@notifyType:1:新员工  2:得钱  3:彩蛋
	--@args: 
    @return:
]]
function CycleNightClubMainViewUIView:CallNotify(notifyType,...)
    if currentNotifyCount < 10 then
        self:GetNotify(notifyType,...)
    else
        local notify1 = notifyList[1]
        table.remove(notifyList,1)
        self:RecycleNotify(notifyType,notify1)
        self:GetNotify(notifyType,...)
    end
    
end

function CycleNightClubMainViewUIView:GetNotify(notifyType,...)
    currentNotifyCount = currentNotifyCount + 1
    if notifyType == 1 then -- 员工
        local callback = function(go,id,...)
            self:SetText(go,"bg/content/txt",GameTextLoader:ReadText("TXT_INSTANCE_NOTIFY_EMPLOYEE"))

            go.transform:SetAsFirstSibling()    --将该节点移到父物体的第一个子节点位置
            local feel = self:GetComp(go,"openFB","MMFeedbacks")
            feel.Events.OnComplete:AddListener(function()
                self:RecycleNotify(notifyType,go)
            end)
            table.insert(notifyList,go)
        end
        Tools:SetTempGo(employeeNotify,1,false,callback)
        
    elseif notifyType == 2 then -- 得钱
        local callback = function(go,id,...)
            local money = select (1,...)
            money = BigNumber:FormatBigNumber(money)
            self:SetText(go,"bg/content/txt","+"..money)
            local resCfg = select (2,...)
            local Image = self:GetComp(go,"bg/category/icon","Image")
            self:SetSprite(Image,"UI_Common",resCfg.icon)

            go.transform:SetAsFirstSibling()    --将该节点移到父物体的第一个子节点位置
            local feel = self:GetComp(go,"openFB","MMFeedbacks")
            feel.Events.OnComplete:AddListener(function()
                self:RecycleNotify(notifyType,go)
            end)

            SoundEngine:PlaySFX("Assets/Res/Audio/SFX_income.ogg", false)
            table.insert(notifyList,go)
        end
        Tools:SetTempGo(moneyNotify,1,false,callback,...)
    elseif notifyType == 3 then -- 得彩蛋
        local callback = function(go,id,...)
            local level = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel()
            local rewardConfig = ConfigMgr.config_cy_instance_reward[CycleInstanceDataManager:GetCurrentModel().instance_id or 4][level]
            local rewardShopConfig = ConfigMgr.config_shop[rewardConfig.shop_id]
            local Image = self:GetComp(go,"bg/category/icon","Image")
            self:SetSprite(Image,"UI_Common",rewardShopConfig.icon)

            go.transform:SetAsFirstSibling()    --将该节点移到父物体的第一个子节点位置
            local feel = self:GetComp(go,"openFB","MMFeedbacks")
            feel.Events.OnComplete:AddListener(function()
                self:RecycleNotify(notifyType,go)
            end)
        end
        Tools:SetTempGo(milestoneNotify,1,false,callback,...)
    end
end

function CycleNightClubMainViewUIView:RecycleNotify(notifyType,notifyGO)
    for i=1,#notifyList do
        if notifyList[i] == notifyGO then
            table.remove( notifyList,i)
            break
        end
    end
    currentNotifyCount = currentNotifyCount -1
    GameObject.Destroy(notifyGO)
end


function CycleNightClubMainViewUIView:Show()
    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    --资源栏
    --钱
    local moneyStr = currentModel:GetCurInstanceCoinShow()
    self.m_moneyText.text = moneyStr

    --钻石
    local diamond = ResourceManger:GetDiamond()
    local diamondStr = Tools:SeparateNumberWithComma(diamond)
    self.m_diamondText.text = diamondStr

    --里程碑信息栏
    local currentAchievement = currentModel:GetCurInstanceKSLevel()
    local maxLevel = currentModel:GetMaxAchievementLevel()

    local notClaimedLevel = currentModel:GetNotClaimedLevel()
    local currentLevelScore = currentModel:GetCurInstanceScore()
    local showNotClaimLevel = notClaimedLevel~=0 and notClaimedLevel<(currentAchievement + 1)

    local targetLevel = showNotClaimLevel and notClaimedLevel or (currentAchievement + 1)

    if targetLevel >=  maxLevel then
        targetLevel = maxLevel
    end
    local rewardConfig = ConfigMgr.config_cy_instance_reward[currentModel.instance_id][targetLevel]
    local currentLevelScoreMax = rewardConfig.experience
    currentLevelScore = showNotClaimLevel and currentLevelScoreMax or currentLevelScore
    ----提醒有里程碑奖励没有领取
    self:RefreshRewardAnim()

    --刷新礼包按钮
    self:RefreshPackButton()
end

---提醒有里程碑奖励没有领取
function CycleNightClubMainViewUIView:RefreshRewardAnim()
    if self.m_milestoneAnimation then
        local needShowRewardAnim = CycleInstanceDataManager:GetCurrentModel():IsAnyRewardCanClaim()
        if needShowRewardAnim then
            self.m_milestoneAnimation:Play()
            self.m_milestoneVfx1GO:SetActive(true)
            self.m_milestoneVfx2GO:SetActive(true)
        else
            AnimationUtil.Reset(self.m_milestoneAnimation,"instance_charge")
            self.m_milestoneVfx1GO:SetActive(false)
            self.m_milestoneVfx2GO:SetActive(false)
        end
    end
end

function CycleNightClubMainViewUIView:GetShowScoreAndShowMaxScore()
    local currentAchievement = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel()
    local maxLevel = CycleInstanceDataManager:GetCurrentModel():GetMaxAchievementLevel()

    local notClaimedLevel = CycleInstanceDataManager:GetCurrentModel():GetNotClaimedLevel()
    local notClaimedLevel = 0
    local showScore = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceScore()
    local showNotClaimLevel = notClaimedLevel~=0 and notClaimedLevel<(currentAchievement + 1)

    local targetLevel = showNotClaimLevel and notClaimedLevel or (currentAchievement + 1)

    if targetLevel >= maxLevel then
        targetLevel = maxLevel
    end
    local achievementConfig = CycleInstanceDataManager:GetCurrentModel().config_cy_instance_reward[targetLevel]
    local showMaxScore = achievementConfig.condition
    showScore = showNotClaimLevel and showMaxScore or showScore

    return showScore,showMaxScore
end

function CycleNightClubMainViewUIView:GetDebuffCount()
    local workers = CycleInstanceDataManager:GetCurrentModel().workerList
    local hungry,physical,debugWorker,allWorker = 0,0,0,0
    local stateThreshold = CycleInstanceDataManager.config_global.stateThreshold
    for k,v in pairs(workers) do
        if next(v) ~= nil then
            for _,furIndex in pairs(v) do
                local attrs = CycleInstanceDataManager:GetCurrentModel():GetWorkerAttr(k,furIndex)
                allWorker = allWorker + 1
                if attrs.hungry < stateThreshold or attrs.physical < stateThreshold  then
                    debugWorker = debugWorker + 1
                    if attrs.hungry < stateThreshold  then
                        hungry = hungry + 1
                    end
                    if attrs.physical < stateThreshold  then
                        physical = physical + 1
                    end
                end
            end
        end
    end

    return hungry,physical,debugWorker,allWorker
end

function CycleNightClubMainViewUIView:GetMaxAchievementLevel()
    local config = CycleInstanceDataManager.config_achievement_instance
    local result = 0
    for k,v in pairs(config) do
        if v.level >= result then
            result = v.level
        end
    end
    return result
end


function CycleNightClubMainViewUIView:SetAchievementActive(active)
    self:GetGo("Milestone"):SetActive(active)
    --self:GetGo("DetailPanel/SettingBtn"):SetActive(false)
    if active then
        self:RefreshRewardAnim()
    end
end

function CycleNightClubMainViewUIView:SetEventActive(active)
    local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone)
    self:GetGo("EventArea"):SetActive(active and guide2IsComplete)
end

function CycleNightClubMainViewUIView:SetEventIAAActive(active)
    self:GetGo("EventArea/IAA"):SetActive(active)
end

function CycleNightClubMainViewUIView:SetPackActive(active)
    local guide2IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone)
    self.m_packBtn.gameObject:SetActive(active and guide2IsComplete)
end

function CycleNightClubMainViewUIView:RefreshPackButton()
    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    local guide2IsComplete = currentModel:IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone)
    local active = currentModel:IsAnyGiftPackIsActive()
    self:SetPackActive(active and guide2IsComplete)
end

-----刷新蓝图按钮
function CycleNightClubMainViewUIView:RefreshBlueprintButton()
    local guide4IsComplete = CycleInstanceDataManager:GetCurrentModel():IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone)
    self.m_blueprintBtn.gameObject:SetActive(guide4IsComplete)
    --self.m_blueprintBtn.gameObject:SetActive(true)
end

function CycleNightClubMainViewUIView:GetRemainingTimeString()
    local state = CycleInstanceDataManager:GetInstanceState()
    local timeRemaining = 0
    if state == CycleInstanceDataManager.instanceState.isActive then
        timeRemaining = CycleInstanceDataManager:GetLeftInstanceTime()
    else
        GameTimer:StopTimer(self.packBtnTimer)
        self.packBtnTimer = nil
        return
    end
    local timeDate = GameTimeManager:GetTimeLengthDate(timeRemaining)
    local d = timeDate.d
    local h = timeDate.h + d * 24
    local m = timeDate.m
    local s = timeDate.s
    if h < 10 then h = "0"..h end
    if m < 10 then m = "0"..m end
    if s < 10 then s = "0"..s end
    local timeStr = string.format("%s:%s:%s",h,m,s)
    return timeStr
end

function CycleNightClubMainViewUIView:RefreshShopButton()
    local freeItemData = {}
    freeItemData.canUse = CycleInstanceDataManager:GetCurrentModel():CanGetFreeSlotCoin()
    freeItemData.amount = ConfigMgr.config_global.cycle_instance_freeCoinNum
    freeItemData.icon = ConfigMgr.config_global.cycle_instance_freeCoinIcon
    freeItemData.leftTimes = ConfigMgr.config_global.cycle_instance_freeCoinFre - CycleInstanceDataManager:GetCurrentModel():GetCurFreeSlotCoinTimes()
    self.m_shopBtnRedPoint:SetActive(freeItemData.canUse and freeItemData.leftTimes > 0)
end

function CycleNightClubMainViewUIView:CheckLastOneDay()
    -- if not self.IsLastOneDay then
    --     if not self.CheckLastOneDayTimer then
    --         self.CheckLastOneDayTimer = GameTimer:CreateNewTimer(1, function()
    --             if CycleInstanceDataManager:GetCurrentModel():GetCurInstanceKSLevel() then
    --                 self.IsLastOneDay = true
    --                 -- self:RefreshShopButton()
    --                 GameTimer:StopTimer(self.CheckLastOneDayTimer)
    --                 self.CheckLastOneDayTimer = nil
    --             end
    --         end, true, true)            
    --     end
    -- end
end

---播放动画前计算Slider的max,min,value
--function CycleNightClubMainViewUIView:RefreshSlider()
--    local showScore,showMaxScore = self:GetShowScoreAndShowMaxScore()
--
--    local slider = self:GetComp("DetailPanel/milestone/currentProg/prog","Slider")
--    local curProgress = (slider.value-slider.minValue)/(slider.maxValue-slider.minValue)
--    local targetProgress = showScore/showMaxScore
--    --printf(string.format("curProgress/targetProgress = %.2f/%.2f",curProgress,targetProgress))
--    if targetProgress ~= curProgress then
--        local len = 1/(targetProgress-curProgress)
--        local min = -curProgress*(len)
--        local max = min+len
--        slider.maxValue = max
--        slider.minValue = min
--        slider.value = len * curProgress + min
--        return true
--    else
--        return false
--    end
--end

function CycleNightClubMainViewUIView:RefreshMilestone()
    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    --里程碑信息栏
    local currentAchievement = currentModel:GetCurInstanceKSLevel()
    local maxLevel = currentModel:GetMaxAchievementLevel()

    local notClaimedLevel = currentModel:GetNotClaimedLevel()
    local currentLevelScore = currentModel:GetCurInstanceScore()
    local showNotClaimLevel = notClaimedLevel ~= 0 and notClaimedLevel < (currentAchievement + 1)

    local targetLevel = showNotClaimLevel and notClaimedLevel or (currentAchievement + 1)
    if targetLevel >= maxLevel then
        targetLevel = maxLevel
    end
    local achievementConfig = currentModel.config_cy_instance_reward[targetLevel]
    local currentLevelScoreMax = achievementConfig.experience
    currentLevelScore = showNotClaimLevel and currentLevelScoreMax or currentLevelScore

    self.m_mileProgressText.text = BigNumber:FormatBigNumber(currentLevelScore)
    self.m_mileLimitText.text = BigNumber:FormatBigNumber(currentLevelScoreMax)

    local slider = self.m_mileSlider
    slider.minValue = 0
    slider.maxValue = 1
    slider.value = currentLevelScore / currentLevelScoreMax
    local icon = ConfigMgr.config_shop[currentModel.config_cy_instance_reward[targetLevel].shop_id].icon
    local shopID = currentModel.config_cy_instance_reward[targetLevel].shop_id
    if shopID then
        local shopCfg = ConfigMgr.config_shop[shopID]
        if shopCfg.type == 9 then
            if shopCfg.country == 0 then
                if GameTableDefine.CityMode:CheckBuildingSatisfy(700) then
                    icon = icon.."_euro"
                end
            elseif shopCfg.country == 2 then
                icon = icon.."_euro"
            end
        end
    end
    self:SetSprite(self.m_mileRewardIcon, "UI_Shop", icon)
    self.m_mileVfxGO:SetActive(targetLevel <= currentAchievement)
    self.m_mileCurLevelText.text = tostring(currentModel:GetCurInstanceKSLevel())
    self.m_mileMaxLevelText.text = tostring(Tools:GetTableSize(currentModel.config_cy_instance_reward))
    self:CheckMilestoneGuide()
end

--检查是否应该开启里程碑引导
function CycleNightClubMainViewUIView:CheckMilestoneGuide()

    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    --1.是否开启过引导
    if currentModel:IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone) then
        return false
    end
    --2.是否有奖励可领取
    local noClaimedRewards = currentModel:GetAllSKRewardNotClaim()
    if not noClaimedRewards or #noClaimedRewards == 0 then
        return false
    end
    --3.是否可操作状态
    if not GameUIManager:GetEnableTouch() then
        return false
    end
    --4.是否位于主界面
    if not GameUIManager:UIIsOnTop(ENUM_GAME_UITYPE.CYCLE_NIGHT_CLUB_MAIN_VIEW_UI,true) then
        return false
    end
    --5.是否在播放TimeLine
    if currentModel:GetScene():IsPlayingTimeLine() then
        return false
    end
    --6.是否在转场云层
    if GameUIManager:IsUIOpen(ENUM_GAME_UITYPE.CYCLE_NIGHT_CLUB_CUT_SCREEN_UI) then
        return false
    end

    --5.条件都满足，开启引导.
    GuideManager.currStep = CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone
    GuideManager:ConditionToStart()
    currentModel:SetGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone)
    return true
end

---播放里程碑分数奖励动画
function CycleNightClubMainViewUIView:PlayMilestoneAnim()
    self:RefreshMilestone()
    local fb = self:GetComp("Milestone/currentProg/prog/Fill Area/Fill/vfx/fb","MMFeedbacks")
    fb:PlayFeedbacks()
end

function CycleNightClubMainViewUIView:OpenTestResWatch()
    if self.testResWatchTimer then
        GameTimer:StopTimer(self.testResWatchTimer)
        self.testResWatchTimer = nil
    end
    --self.testResWatchTimer = GameTimer:CreateNewTimer(1, function()
    --    --1、钞票总量
    --    --2、钞票产出效率
    --    --3、经验书总量
    --    --4、经验书产出效率
    --    --5、扭蛋币总量
    --    --6、里程碑积分
    --    local totalCoin = math.floor(CycleInstanceDataManager:GetCurrentModel():GetCurInstanceCoin())
    --    local _, tmpSpwanCoin = CycleInstanceDataManager:GetCurrentModel():CalculateOfflineRewards(60)
    --    local spawnCoin = math.floor(tmpSpwanCoin)
    --    local heroUpExp = CycleInstanceDataManager:GetCurrentModel():GetCurHeroExpRes()
    --    local spwanHeroUpExp = math.floor(CycleInstanceDataManager:GetCurrentModel():GetExpOutputPerMin())
    --    local slotCoin = CycleInstanceDataManager:GetCurrentModel():GetCurSlotCoin()
    --    local mileCoin = CycleInstanceDataManager:GetCurrentModel():GetCurInstanceScore()
    --    self:SetText("ResourceBG/Res_Line/cash/num", BigNumber:FormatBigNumber(totalCoin))
    --    self:SetText("ResourceBG/Res_Line/cash_min/num", BigNumber:FormatBigNumber(spawnCoin).."/min")
    --    self:SetText("ResourceBG/Res_Line/hero/num", BigNumber:FormatBigNumber(heroUpExp))
    --    self:SetText("ResourceBG/Res_Line/hero_min/num", BigNumber:FormatBigNumber(spwanHeroUpExp).."/min")
    --    self:SetText("ResourceBG/Res_Line/coin/num", Tools:SeparateNumberWithComma(slotCoin))
    --    self:SetText("ResourceBG/Res_Line/point/num", BigNumber:FormatBigNumber(mileCoin))
    --end, true, true)
end

function CycleNightClubMainViewUIView:CloseTestResWatch()
    if self.testResWatchTimer then
        GameTimer:StopTimer(self.testResWatchTimer)
        self.testResWatchTimer = nil
    end
end

---定时刷新任务状态
function CycleNightClubMainViewUIView:StartRefreshButtonTips()
    if self.m_refreshTaskTimer then
        return
    end
    local taskTipGO = self:GetGo("BottomPanel/TaskBtn/icon")
    local slotMachineTipGO = self:GetGo("BottomPanel/SlotBtn/icon")
    local skillTipGo = self:GetGo("BottomPanel/SkillBtn/icon")
    local bluePrintTipGo = self:GetGo("BottomPanel/BlueprintBtn/icon")
    self.m_refreshTaskTimer = GameTimer:CreateNewTimer(1,function()
        local currentModel = CycleInstanceDataManager:GetCurrentModel() ---@type CycleNightClubModel
        taskTipGO:SetActive(CycleNightClubTaskManager:UpdateTaskState(true))
        local canSlot = currentModel:GetCurSlotCoin()>=5
        slotMachineTipGO:SetActive(canSlot)
        skillTipGo:SetActive(currentModel:CheckSkillCanUpdate())

        bluePrintTipGo:SetActive(currentModel:CheckBlueprintTip())

        self:RefreshShopButton()
    end,true,true)
end

---播放副本故事TimeLine时隐藏CycleMainUI
---@param isPlay boolean -等于true播放显示动画，等于false隐藏
function CycleNightClubMainViewUIView:GuideTimeUIState(isPlay)
    local animation = self.m_uiObj:GetComponent("Animation")
    animation.enabled = true
    if isPlay then
        AnimationUtil.Play(animation, "UI_transfer_instace", nil, 1, "KEY_FRAME_ANIM_END")
    else
        AnimationUtil.GotoAndStop(animation, "UI_transfer_instace", "KEY_FRAME_ANIM_END")
    end
end

function CycleNightClubMainViewUIView:PlayCloseGiftAnima()
    local animation = self:GetComp("BottomPanel/PackBtn/pack_Fly", "Animator")
    --AnimationUtil.Play(animation, "Instance2_pack_Fly_Anim", nil, 1)
    animation:Play("Instance3_pack_Fly_Anim",0,0)
end

---引导完成解锁UI界面
function CycleNightClubMainViewUIView:RefreshUIEntryByGuideState()
    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    --是否完成引导2
    local guide2IsComplete = currentModel:IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockMilestone)
    self:GetGo("BottomPanel/SlotBtn"):SetActive(guide2IsComplete)
    self.m_shopBtn.gameObject:SetActive(guide2IsComplete)
    self.m_packBtn.gameObject:SetActive(guide2IsComplete)
    self:GetGo("BottomPanel/TaskBtn"):SetActive(guide2IsComplete)
    self:GetGo("EventArea"):SetActive(guide2IsComplete)

    --self:GetGo("BottomPanel/SellBtn"):SetActive(guide2IsComplete)
    self:GetGo("BottomPanel/SkillBtn"):SetActive(guide2IsComplete)
    self:GetGo("ResourceBG/DiamondInterface/AddBtn"):SetActive(guide2IsComplete)

    --是否完成引导4
    self:RefreshBlueprintButton()
end


---检查是否需要触发第二循环的引导对话
function CycleNightClubMainViewUIView:CheckSecondCycleGuide()
    local currentModel = CycleInstanceDataManager:GetCurrentModel()
    --1.是否触发过引导
    if currentModel:IsGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockedSecondCycle) then
        return false
    end
    --2.是否是解锁9号房间
    if not currentModel:RoomIsUnlock(1052) then
        return false
    end
    --3.是否有足够的货币升级一号房间第四级
    local roomLevelCfg = currentModel:GetRoomLevelConfig(1044,4)
    local cost = roomLevelCfg.upgrade_cost or 0
    if BigNumber:CompareBig(cost, currentModel:GetCurInstanceCoin()) then
        return false
    end
    --4.开启引导
    GameUIManager:SetEnableTouch(false)
    GuideManager.currStep = CycleInstanceDefine.GuideDefine.NightClub.UnlockedSecondCycle
    GuideManager:ConditionToStart()
    currentModel:SetGuideCompleted(CycleInstanceDefine.GuideDefine.NightClub.UnlockedSecondCycle)
    return true
end

function CycleNightClubMainViewUIView:RefreshPiggyBank()
    local curValue, maxValue = GameTableDefine.CycleInstanceDataManager:GetCurrentModel():GetPiggyBankValue()
    if not curValue or not maxValue or curValue < 0 then
        self.m_piggyBankGO:SetActive(false)
        return
    end

    self.m_piggyBankGO:SetActive(true)
    self.m_piggyBankRedPointGO:SetActive(curValue >= maxValue)
    self.m_piggyBankSlider.value = math.min(1, curValue / maxValue)
    self.m_piggyBankCurValueText.text = curValue
    self.m_piggyBankMaxValueText.text = maxValue
end


return CycleNightClubMainViewUIView