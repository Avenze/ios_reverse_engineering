---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2024/10/29 10:13
---

--等待传送带上的商品送到底的状态

local Class = require("Framework.Lua.Class")
local AIStateBase = require("CodeRefactoring.AI.StateMachines.AIStateBase")
local CycleInstanceDataManager = GameTableDefine.CycleInstanceDataManager
local UIView = require("Framework.UI.View") -- 当工具类使用
local Vector3 = CS.UnityEngine.Vector3
local UnityHelper = CS.Common.Utils.UnityHelper
local PERSON_ACTION = require("CodeRefactoring.Actor.PersonActionDefine")
local ActorDefine = require("CodeRefactoring.Actor.ActorDefine")

---@class CycleToyWorkerWaitState:AIStateBase
---@field m_owner CycleToyWorker
local CycleToyWorkerWaitState = Class("CycleToyWorkerWaitState",AIStateBase)

function CycleToyWorkerWaitState:ctor()

end

function CycleToyWorkerWaitState:OnEnter(...)
    local actor = self.m_owner
    local actorData = actor.data
    -- 初始化在工作点
    if not actor:FindWorkPosition() then
        print("找不到家具")
        return
    end
    local face = actorData.actFaceTr
    
    actor.gameObject.transform.position = actorData.actPosTr.position
    UnityHelper.RotateTowards(actor.gameObject.transform, Vector3(face.position.x, actorData.actPosTr.position.y, face.position.z))

    --尝试卸货
    local conveyorSystem = self.m_owner:GetConveyorSystem()
    local releaseGoodsComplete = false
    if conveyorSystem then
        releaseGoodsComplete = self.m_owner:GetConveyorSystem():ReleaseArrivedGoodsByIndex(self.m_owner.data.furnitureIndex-1)
    end
    if releaseGoodsComplete then
        self.m_owner.m_stateMachine:ChangeState(ActorDefine.CycleInstanceState.CycleToyWorkerWorkState)
    else
        --转入等待，等到货事件
        -- 播放等待动画
        actor:SetAnimator(PERSON_ACTION.IDLE)
        -- 隐藏气泡
        --actor:SetTheDisplayOfBubbles()
    end
end

function CycleToyWorkerWaitState:OnExit()

end

function CycleToyWorkerWaitState:Event(msg, params)
    if msg == ActorDefine.CycleInstanceEvent.GoodsArrived then
        self.m_owner:GetConveyorSystem():ReleaseArrivedGoodsByIndex(self.m_owner.data.furnitureIndex-1)
        self.m_owner.m_stateMachine:ChangeState(ActorDefine.CycleInstanceState.CycleToyWorkerWorkState)
    end
end

return CycleToyWorkerWaitState