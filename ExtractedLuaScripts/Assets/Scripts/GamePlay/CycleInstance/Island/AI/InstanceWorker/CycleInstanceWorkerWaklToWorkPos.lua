---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2024/7/1 14:13
---

local Class = require("Framework.Lua.Class")
local AIStateBase = require("CodeRefactoring.AI.StateMachines.AIStateBase")
local ActorDefine = require("CodeRefactoring.Actor.ActorDefine")
local CfgMgr = GameTableDefine.ConfigMgr
local CycleInstanceDataManager = GameTableDefine.CycleInstanceDataManager
local CycleInstanceAIBlackBoard = GameTableDefine.CycleInstanceAIBlackBoard
local UIView = require("Framework.UI.View") -- 当工具类使用
local Random = CS.UnityEngine.Random
local Vector3 = CS.UnityEngine.Vector3
local UnityHelper = CS.Common.Utils.UnityHelper
local PERSON_ACTION = require("CodeRefactoring.Actor.PersonActionDefine")

local WALK_SPEED = 5.5
local RUN_SPEED = 15



---@class CycleInstanceWorkerWaklToWorkPos:AIStateBase
---@field m_owner CycleInstanceWorkerClass
local CycleInstanceWorkerWaklToWorkPos = Class("CycleInstanceWorkerWaklToWorkPos",AIStateBase)

function CycleInstanceWorkerWaklToWorkPos:ctor()
    self.m_timerID = nil
    self.m_speed = nil
end

function CycleInstanceWorkerWaklToWorkPos:OnEnter(...)
    local actor = self.m_owner
    local actorData = actor.data
    local stateMachine = actor.m_stateMachine
    local speed = WALK_SPEED + Random.Range(-1.1, 1.1)
    if not actorData.workPosTr or actorData.workPosTr:IsNull() then
        actorData.furGO = CycleInstanceDataManager:GetCurrentModel():GetSceneRoomFurnitureGo(actorData.roomId ,1)
        actorData.workPosTr = UIView:GetTrans(actorData.furGO, "workPos_" .. actorData.furIndex) --工位点
        actorData.workFaceTr = UIView:GetTrans(actorData.workPosTr.gameObject, "face") --工位点朝向
        actorData.actPosTr = UIView:GetTrans(actorData.roomGO, "actionPos/actionPos_" .. actorData.furIndex) or actorData.workPosTr --工位点
        actorData.actFaceTr = UIView:GetTrans(actorData.roomGO, "actionPos/actionPos_" .. actorData.furIndex .. "/face") or actorData.workFaceTr --工位点

    end
    --寻路到workSet
    actor:CalculatePath(
            actorData.actPosTr.position,
            true,
            speed,
            Random.Range(1.1, 4.1),
            function()
                actor:TryTransState(
                        function()
                            stateMachine:ChangeState(ActorDefine.CycleInstanceState.CycleInstanceWorkerWork)
                        end
                )
            end
    )
    --播放动画
    actor:SetAnimator(PERSON_ACTION.WALK)
    -- 显示气泡
    actor:SetTheDisplayOfBubbles()

end

function CycleInstanceWorkerWaklToWorkPos:OnExit()

end

return CycleInstanceWorkerWaklToWorkPos