---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2025/2/6 15:33
---

---@class CEOHiredUI
local CEOHiredUI = GameTableDefine.CEOHiredUI

local UIView = require("Framework.UI.View")
local EventManager = require("Framework.Event.Manager")
local GameResMgr = require("GameUtils.GameResManager")

local GameUIManager = GameTableDefine.GameUIManager
local MainUI = GameTableDefine.MainUI
local CEODataManager = GameTableDefine.CEODataManager
local ConfigMgr = GameTableDefine.ConfigMgr

local GameObject = CS.UnityEngine.GameObject
local UnityHelper = CS.Common.Utils.UnityHelper ---@type Common.Utils.UnityHelper
local Vector3 = CS.UnityEngine.Vector3

function CEOHiredUI:InitUI()
    local canvasGO = UIView:GetGo(self.m_GuideTimeGo,"Canvas")
    local ceoID = self.m_ceoID
    local ceoLevel = CEODataManager:GetCEOLevel(ceoID)

    local normalBG = UIView:GetGo(canvasGO,"UI/background/topPanel/head/normal")
    local premiumBG = UIView:GetGo(canvasGO,"UI/background/topPanel/head/premium")
    local ceoConfig = CEODataManager:GetCEOConfig(ceoID)
    normalBG:SetActive(ceoConfig.ceo_quality == CEODataManager.CEORankType.Normal)
    premiumBG:SetActive(ceoConfig.ceo_quality == CEODataManager.CEORankType.Premium)

    local CEOIcon = UIView:GetComp(canvasGO,"UI/background/topPanel/head/icon","Image")
    UIView:SetSprite(CEOIcon,"UI_Shop",ceoConfig.ceo_head,nil,false,true)

    local buffIcon = UIView:GetComp(canvasGO,"UI/background/topPanel/info/resIcon","Image")
    UIView:SetSprite(buffIcon,"UI_Common",CEODataManager.CEOBuffIcon[ceoConfig.ceo_effect_type])

    local ceoLevelConfig = CEODataManager:GetCEOLevelConfig(ceoID,ceoLevel)
    local roomIndex, countryId = CEODataManager:GetCEOSpecificRoomIndexByCEOID(ceoID)
    local furLevel = CEODataManager:GetCEOFurnitureLevelByRoomIndex(roomIndex, countryId)

    --local CEOBuffCashGO = UIView:GetGo(canvasGO,"UI/background/topPanel/info/desc_income")
    --local CEOBuffExpGO = UIView:GetGo(canvasGO,"UI/background/topPanel/info/desc_exp")
    --CEOBuffCashGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Income)
    --CEOBuffExpGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Exp)
    local curDeskConfig = ConfigMgr.config_ceo_furniture_level[furLevel]
    if curDeskConfig then
        local furLevelEnough = curDeskConfig.table_ceo_limit>=ceoLevel
        local buffAddRatio = ceoLevelConfig.ceo_effect - 1
        local buffText
        if furLevelEnough then
            buffText = string.format("x%.1f",100+buffAddRatio*100).."%"
        else
            buffText = string.format("x%.1f",100+buffAddRatio*50).."%"
        end
        UIView:SetText(canvasGO,"UI/background/topPanel/info/num",buffText)
    end
end

function CEOHiredUI:ChangeCEOPrefab()
    local ceoRootGO = UIView:GetGo(self.m_GuideTimeGo,"Character/CEO")
    local preTrans = ceoRootGO.transform:GetChild(0)
    preTrans.gameObject:SetActive(false)

    local ceoConfig = CEODataManager:GetCEOConfig(self.m_ceoID)
    local employee_skin = "Assets/Res/Prefabs/character/" .. ceoConfig.ceo_prefab .. ".prefab"
    GameResMgr:AInstantiateObjectAsyncManual(employee_skin,self,function(go)
        local preScale = Vector3(3,3,3)
        if ceoRootGO.transform.childCount>0 then
            preScale = preTrans.localScale
            GameObject.Destroy(preTrans.gameObject)
        end
        UnityHelper.AddChildToParent(ceoRootGO.transform,go.transform)
        go.transform.localScale = preScale
        UnityHelper.ChangeTimelineAnimator(self.m_GuideTimeLine,"CEO",go)
    end)
end

function CEOHiredUI:ChangeBossPrefab()
    local bossRootGO = UIView:GetGo(self.m_GuideTimeGo,"Character/BOSS")

    GameTableDefine.DressUpDataManager:LoadPersonGO(1,function(go)
        local preScale = Vector3(3,3,3)
        if bossRootGO.transform.childCount>0 then
            local preTrans = bossRootGO.transform:GetChild(0)
            preScale = preTrans.localScale
            GameObject.Destroy(preTrans.gameObject)
        end
        UnityHelper.AddChildToParent(bossRootGO.transform,go.transform)
        go.transform.localScale = preScale
        UnityHelper.ChangeTimelineAnimator(self.m_GuideTimeLine,"BOSS",go)
    end)
end

function CEOHiredUI:Show(ceoID,cb_OnEnd)

    self.m_ceoID = ceoID
    -- MainUI:GuideTimeUIState()

    EventManager:RegEvent("EVENT_GUIDE_TIMELINE_END", function(go)
        GameUIManager:SetEnableTouch(true)
        GameObject.Destroy(self.m_GuideTimeGo)
        self.m_GuideTimeGo = nil
        self.m_GuideTimeLine = nil
        UnityHelper.RemoveCameraFromCameraStack(GameUIManager:GetSceneCamera(), self.m_storyCamera)
        -- MainUI:GuideTimeUIState(true)

        if cb_OnEnd then
            cb_OnEnd()
        end
    end)

    GameResMgr:AInstantiateObjectAsyncManual("Assets/Res/UI/CeoHiredUI.prefab", self, function(childGo)
        --local bossRootGO = UIView:GetGo(childGo, "Canvas/Character/BOSS")
        --bossRootGO:SetActive(true)

        --GameTableDefine.DressUpDataManager:ChangeTimelineActorDressUp(childGo)

        self.m_GuideTimeGo = childGo
        self.m_GuideTimeLine = childGo:GetComponent("PlayableDirector")
        self.m_storyCamera = UnityHelper.GetTheChildComponent(childGo, "UI_Camera_Story", "Camera")
        if self.m_storyCamera then
            UnityHelper.SetCameraRenderType(self.m_storyCamera, 1)
            UnityHelper.AddCameraToCameraStack(GameUIManager:GetSceneCamera(), self.m_storyCamera, 0)
        end

        GameUIManager:SetEnableTouch(false)

        self:InitUI()
        self:ChangeCEOPrefab()
        self:ChangeBossPrefab()
    end)
end

return CEOHiredUI