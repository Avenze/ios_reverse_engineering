---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenlongfa.
--- DateTime: 2025/2/6 15:33
---

local Class = require("Framework.Lua.Class")
local UIView = require("Framework.UI.View")

local GameTimeManager = GameTimeManager
local GameTimer = GameTimer
local FloorMode = GameTableDefine.FloorMode
local CompanyMode = GameTableDefine.CompanyMode
local ConfigMgr = GameTableDefine.ConfigMgr
local CEODataManager = GameTableDefine.CEODataManager
local PetListUI = GameTableDefine.PetListUI
local CEOHiringUI = GameTableDefine.CEOHiringUI
local ResourceManger = GameTableDefine.ResourceManger
local CEOHiredUI = GameTableDefine.CEOHiredUI

local COMPANY_LEVEL_HOLDER_MAX = 7

---@class CEIInfoUIView:UIBaseView
local CEIInfoUIView = Class("CEIInfoUIView", UIView)

function CEIInfoUIView:ctor()
    self.m_list = nil ---@type UnityEngine.UI.ScrollRectEx
    self.m_OperateCEOID = nil
end

function CEIInfoUIView:OnEnter()
    local quitBtn = self:GetComp("background/headPanel/QuitBtn","Button")
    self:SetButtonClickHandler(quitBtn,function()
        self:DestroyModeUIObject()
    end)

    self.m_list = self:GetComp("background/list","ScrollRectEx")

    self:SetListUpdateFunc(self.m_list,handler(self,self.UpdateList))
    self:SetListItemCountFunc(self.m_list,function()
        return #self.m_ceoRoomIndexList
    end)
    self:SetListItemNameFunc(self.m_list,function()
        return "info"
    end)

    self.m_ceoRoomIndexList = {}

    local roomDatas = FloorMode:GetAllRoomsLocalData()
    for roomIndex,roomData in pairs(roomDatas) do
        if roomData.unlock and roomData.ceoFurnitureInfo then
            self.m_ceoRoomIndexList[#self.m_ceoRoomIndexList+1] = roomIndex
        end
    end

    table.sort(self.m_ceoRoomIndexList,function(a, b)
        local numA = FloorMode:GetRoomIdByRoomIndex(a)
        local numB = FloorMode:GetRoomIdByRoomIndex(b)
        return numA<numB
    end)
end

function CEIInfoUIView:Init(operateCEOID, closeCB)
    self.closeCB = closeCB
    self.m_list:UpdateData(true)
    self.m_OperateCEOID = operateCEOID
end

function CEIInfoUIView:Refresh(roomIndex1,roomIndex2)
    self.m_needShowShineRoomIndex1 = roomIndex1
    self.m_needShowShineRoomIndex2 = roomIndex2
    self.m_list:UpdateData()
end

---@param trans UnityEngine.Transform
function CEIInfoUIView:UpdateList(index,trans)
    index = index+1
    local go = trans.gameObject

    local roomIndex = self.m_ceoRoomIndexList[index]

    self:InitRoomInfo(roomIndex,go)
    self:InitCEOInfo(roomIndex,go)
    self:InitDeskInfo(roomIndex,go)

    --是否显示shine节点
    local showShine = false
    if roomIndex == self.m_needShowShineRoomIndex1 then
        showShine = true
        self.m_needShowShineRoomIndex1 = nil
    elseif roomIndex == self.m_needShowShineRoomIndex2 then
        showShine = true
        self.m_needShowShineRoomIndex2 = nil
    end
    if showShine then
        self:GetGo(go,"roomAndBuff/buff/have/shine"):SetActive(true)
    end
end

function CEIInfoUIView:InitRoomInfo(roomIndex,go)
    local roomIndexNumber = FloorMode:GetRoomIndexNumberByRoomIndex(roomIndex)
    self:SetText(go,"roomName/roomNum",FloorMode:GetRoomName(roomIndexNumber))
    local companyId = CompanyMode:CompIdByRoomIndex(roomIndex)
    local isEmpty = companyId == nil

    local furSaveData = FloorMode:GetCurrRoomLocalData(roomIndex).ceoFurnitureInfo
    local ceoID = furSaveData.ceoID
    local ceoLevel = ceoID and CEODataManager:GetCEOLevel(ceoID) or 0
    local furLevel = furSaveData.level

    local haveCompanyGO = self:GetGo(go,"roomAndBuff/company/have")
    local noneCompanyGO = self:GetGo(go,"roomAndBuff/company/none")
    local haveCEOBuffGO = self:GetGo(go,"roomAndBuff/buff/have")
    local noneCEOBuffGO = self:GetGo(go,"roomAndBuff/buff/none")
    local companyCEOBuffUpGO = self:GetGo(haveCEOBuffGO,"title/text_1")
    local companyCEOBuffDownGO = self:GetGo(haveCEOBuffGO,"title/text_2")
    local companyCEOBuffCashGO = self:GetGo(haveCEOBuffGO,"buffDesc/cash")
    local companyCEOBuffExpGO = self:GetGo(haveCEOBuffGO,"buffDesc/exp")

    if not isEmpty then
        haveCompanyGO:SetActive(true)
        noneCompanyGO:SetActive(false)

        local companyData = ConfigMgr.config_company[companyId]

        local companyIcon = self:GetComp(haveCompanyGO,"companyIcon/Icon","Image")
        local companyRankIcon = self:GetComp(haveCompanyGO,"level","Image")
        self:SetSprite(companyIcon, "UI_Common", companyData.company_logo..GameConfig:GetLangageFileSuffix(), nil, true)
        self:SetSprite(companyRankIcon, "UI_Common", "icon_Grade"..companyData.company_quality, nil, true)
        self:SetText(haveCompanyGO,"companyName",GameTextLoader:ReadText("TXT_COMPANY_C"..companyId.."_NAME"))
        local expProgress = CompanyMode:CompanyExpProgress(roomIndex)
        local companyExpSlider = self:GetComp(haveCompanyGO,"progress","Slider")
        companyExpSlider.value = expProgress
        --TODO
        self:SetText(haveCompanyGO,"progress/pro",string.format("%.2f",expProgress*100).."%")

        local maxLevel = ConfigMgr.config_company[companyId].levelMax
        local companyLevel = CompanyMode:GetCompanyLevel(companyId)
        local holderRoot = self:GetGo(haveCompanyGO,"levelHolder")
        for i = 1, COMPANY_LEVEL_HOLDER_MAX do
            local holder = self:GetGo(holderRoot,"star"..i)
            holder:SetActive(i < maxLevel)
            local levelOnGO = self:GetGo(holder, "on")
            levelOnGO:SetActive(i < companyLevel)
        end

        --CEO给公司的数值加成
        if ceoID then
            haveCEOBuffGO:SetActive(true)
            noneCEOBuffGO:SetActive(false)
            local curDeskConfig = ConfigMgr.config_ceo_furniture_level[furLevel]
            if curDeskConfig then
                local furLevelEnough = curDeskConfig.table_ceo_limit>=ceoLevel
                companyCEOBuffUpGO:SetActive(furLevelEnough)
                companyCEOBuffDownGO:SetActive(not furLevelEnough)
                local ceoConfig = ConfigMgr.config_ceo[ceoID]
                companyCEOBuffCashGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Income)
                companyCEOBuffExpGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Exp)
                local ceoLevelConfig = CEODataManager:GetCEOLevelConfig(ceoID,ceoLevel)
                if ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Income then
                    local companyRent = FloorMode:GetCompanyRent(roomIndex)
                    local baseRent = FloorMode:GetRent(roomIndex)
                    local improve = FloorMode:GetSceneEnhance()
                    local totalRent = (companyRent + baseRent) * improve
                    local rentBuffAdd = totalRent * (ceoLevelConfig.ceo_effect - 1)
                    self:SetText(companyCEOBuffCashGO,"num",Tools:SeparateNumberWithComma(totalRent))
                    local companyCashUpAddText = self:GetComp(companyCEOBuffCashGO,"add","TMPLocalization")
                    local companyCashDownAddText = self:GetComp(companyCEOBuffCashGO,"halfAdd","TMPLocalization")
                    companyCashUpAddText.gameObject:SetActive(furLevelEnough)
                    companyCashDownAddText.gameObject:SetActive(not furLevelEnough)
                    if furLevelEnough then
                        companyCashUpAddText.text = "(+"..Tools:SeparateNumberWithComma(rentBuffAdd)..")"
                    else
                        companyCashDownAddText.text = "(+"..Tools:SeparateNumberWithComma(rentBuffAdd*0.5)..")"
                    end
                elseif ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Exp then
                    local expBaseAdd,_ = CompanyMode:RoomExpAdd(roomIndex,true)
                    local expBuffAdd = expBaseAdd * (ceoLevelConfig.ceo_effect - 1)
                    self:SetText(companyCEOBuffExpGO,"num",Tools:SeparateNumberWithComma(expBaseAdd))
                    local companyExpUpAddText = self:GetComp(companyCEOBuffExpGO,"add","TMPLocalization")
                    local companyExpDownAddText = self:GetComp(companyCEOBuffExpGO,"halfAdd","TMPLocalization")
                    companyExpUpAddText.gameObject:SetActive(furLevelEnough)
                    companyExpDownAddText.gameObject:SetActive(not furLevelEnough)
                    if furLevelEnough then
                        companyExpUpAddText.text = "(+"..Tools:SeparateNumberWithComma(expBuffAdd)..")"
                    else
                        companyExpDownAddText.text = "(+"..Tools:SeparateNumberWithComma(expBuffAdd * 0.5)..")"
                    end
                end
            end
        else
            haveCEOBuffGO:SetActive(false)
            noneCEOBuffGO:SetActive(true)
        end
    else
        haveCompanyGO:SetActive(false)
        noneCompanyGO:SetActive(true)

        --CEO给公司的数值加成
        if ceoID then
            haveCEOBuffGO:SetActive(true)
            noneCEOBuffGO:SetActive(false)
            local curDeskConfig = ConfigMgr.config_ceo_furniture_level[furLevel]
            if curDeskConfig then
                local furLevelEnough = curDeskConfig.table_ceo_limit>=ceoLevel
                companyCEOBuffUpGO:SetActive(furLevelEnough)
                companyCEOBuffDownGO:SetActive(not furLevelEnough)
                local ceoConfig = ConfigMgr.config_ceo[ceoID]
                companyCEOBuffCashGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Income)
                companyCEOBuffExpGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Exp)
                if ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Income then
                    local companyCashUpAddText = self:GetComp(companyCEOBuffCashGO,"add","TMPLocalization")
                    local companyCashDownAddText = self:GetComp(companyCEOBuffCashGO,"halfAdd","TMPLocalization")
                    self:SetText(companyCEOBuffCashGO,"num","0")
                    companyCashUpAddText.gameObject:SetActive(furLevelEnough)
                    companyCashDownAddText.gameObject:SetActive(not furLevelEnough)
                    if furLevelEnough then
                        companyCashUpAddText.text = "(+0)"
                    else
                        companyCashDownAddText.text = "(+0)"
                    end
                elseif ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Exp then

                    self:SetText(companyCEOBuffExpGO,"num","0")
                    local companyExpUpAddText = self:GetComp(companyCEOBuffExpGO,"add","TMPLocalization")
                    local companyExpDownAddText = self:GetComp(companyCEOBuffExpGO,"halfAdd","TMPLocalization")
                    companyExpUpAddText.gameObject:SetActive(furLevelEnough)
                    companyExpDownAddText.gameObject:SetActive(not furLevelEnough)

                    if furLevelEnough then
                        companyExpUpAddText.text = "(+0)"
                    else
                        companyExpDownAddText.text = "(+0)"
                    end
                end
            end
        else
            haveCEOBuffGO:SetActive(false)
            noneCEOBuffGO:SetActive(true)
        end
    end
end

function CEIInfoUIView:InitCEOInfo(roomIndex,go)

    local furSaveData = FloorMode:GetCurrRoomLocalData(roomIndex).ceoFurnitureInfo
    local furLevel = furSaveData.level
    local ceoID = furSaveData.ceoID

    local haveCEO = ceoID and true or false

    local hireFunction = function()
        --已选择操作的CEO的情况下，应该用选择的CEO替换这个房间的CEO
        if self.m_OperateCEOID then
            if haveCEO then
                local roomIndex2 = CEODataManager:GetCEOSpecificRoomIndexByCEOID(ceoID)
                if roomIndex2 == "" then
                    roomIndex2 = nil
                end
                GameSDKs:TrackForeign("ceo_interact", {type = "Assign任职"})
                CEODataManager:ExchangeRoomCEO(ceoID,self.m_OperateCEOID)
                CEOHiredUI:Show(self.m_OperateCEOID,function()
                    self:Refresh(roomIndex,roomIndex2)
                end)
                CEODataManager:UpdateCEODataToThinking()
            else
                GameSDKs:TrackForeign("ceo_interact", {type = "Assign任职"})
                CEODataManager:ChangeRoomCEO(roomIndex,self.m_OperateCEOID, GameTableDefine.CountryMode:GetCurrCountry())
                CEOHiredUI:Show(self.m_OperateCEOID,function()
                    self:Refresh(roomIndex)
                end)
                CEODataManager:UpdateCEODataToThinking()
            end
            self.m_OperateCEOID = nil
            if PetListUI.m_view then
                PetListUI:CloseView()
            end
        else
            --未选择操作的CEO的情况下，打开CEO列表
            CEOHiringUI.m_operationRoomIndex = roomIndex
            GameSDKs:TrackForeign("ceo_list", {source = "统筹管理界面"})
            PetListUI:ShowCEOPanel()
        end
    end
    local hireBtn = self:GetComp(go,"ceoInfo/hireBtn","Button")
    local replaceBtn = self:GetComp(go,"ceoInfo/replaceBtn","Button")
    self:SetButtonClickHandler(hireBtn,hireFunction)
    self:SetButtonClickHandler(replaceBtn,hireFunction)

    hireBtn.gameObject:SetActive(not haveCEO)
    replaceBtn.gameObject:SetActive(haveCEO)
    local CEONoneGO = self:GetGo(go,"ceoInfo/ceoIcon/none")
    local CEOHaveGO = self:GetGo(go,"ceoInfo/ceoIcon/have")
    CEONoneGO:SetActive(not haveCEO)
    CEOHaveGO:SetActive(haveCEO)
    local noneArrow = self:GetGo(go,"ceoInfo/hireBtn/arr")
    noneArrow:SetActive(furLevel>0 and not haveCEO)

    if haveCEO then
        local ceoConfig = ConfigMgr.config_ceo[ceoID]

        local CEORankGONormal = self:GetGo(CEOHaveGO,"bg/normal")
        local CEORankGOPremium = self:GetGo(CEOHaveGO,"bg/premium")

        CEORankGONormal:SetActive(ceoConfig.ceo_quality == CEODataManager.CEORankType.Normal)
        CEORankGOPremium:SetActive(ceoConfig.ceo_quality == CEODataManager.CEORankType.Premium)

        local CEOIcon = self:GetComp(CEOHaveGO,"icon","Image")
        self:SetSprite(CEOIcon,"UI_Shop",ceoConfig.ceo_avatar,nil,false,true)
        local ceoLevel = CEODataManager:GetCEOLevel(ceoID)
        self:SetText(CEOHaveGO,"level_bg/num",ceoLevel)

        local ceoLevelConfig = CEODataManager:GetCEOLevelConfig(ceoID,ceoLevel)
        local CEOBuffCashGO = self:GetGo(CEOHaveGO,"buff/cashIcon")
        local CEOBuffExpGO = self:GetGo(CEOHaveGO,"buff/expIcon")
        CEOBuffCashGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Income)
        CEOBuffExpGO:SetActive(ceoConfig.ceo_effect_type == CEODataManager.CEOEffectType.Exp)
        local curDeskConfig = ConfigMgr.config_ceo_furniture_level[furLevel]
        if curDeskConfig then
            local furLevelEnough = curDeskConfig.table_ceo_limit>=ceoLevel
            local CEOBuffUpNumText = self:GetComp(CEOHaveGO,"buff/num","TMPLocalization")
            local CEOBuffDownNumText = self:GetComp(CEOHaveGO,"buff/halfNum","TMPLocalization")
            CEOBuffUpNumText.gameObject:SetActive(furLevelEnough)
            CEOBuffDownNumText.gameObject:SetActive(not furLevelEnough)

            local buffAddRatio = ceoLevelConfig.ceo_effect - 1
            if furLevelEnough then
                CEOBuffUpNumText.text = "x"..string.format("%.2f",100+buffAddRatio*100).."%"
            else
                CEOBuffDownNumText.text = "x"..string.format("%.2f",100+buffAddRatio*50).."%"
            end

            local CEOStateGO = self:GetGo(CEOHaveGO,"state")
            CEOStateGO:SetActive(not furLevelEnough)
        end
    else
        hireBtn.interactable = furLevel > 0
    end
end

function CEIInfoUIView:InitDeskInfo(roomIndex,go)

    local furSaveData = FloorMode:GetCurrRoomLocalData(roomIndex).ceoFurnitureInfo
    local curLevel = furSaveData.level
    local nextDeskConfig = ConfigMgr.config_ceo_furniture_level[curLevel+1]

    local haveDesk = furSaveData.level>0
    local needShowDeskArrow = not haveDesk

    local deskHaveGO = self:GetGo(go,"ceoDesk/deskHave")
    local deskNoneGO = self:GetGo(go,"ceoDesk/deskNone")
    deskHaveGO:SetActive(haveDesk)
    deskNoneGO:SetActive(not haveDesk)

    if haveDesk then
        local curDeskConfig = ConfigMgr.config_ceo_furniture_level[curLevel]
        if curDeskConfig then
            local deskIcon = self:GetComp(deskHaveGO,"deskIcon/icon","Image")
            self:SetSprite(deskIcon,"UI_Common",curDeskConfig.table_icon,nil,false,true)
            --self.m_deskLevelText.text = tostring(curLevel)
            self:SetText(deskHaveGO,"desc/title",GameTextLoader:ReadText(curDeskConfig.table_name))
            self:SetText(deskHaveGO,"desc/ceoLvNeed/icon/level",curLevel)
            self:SetText(deskHaveGO,"deskIcon/level/num",tostring(curLevel))

            local tableDes = string.gsub(GameTextLoader:ReadText(curDeskConfig.table_desc),"%[level%]",tostring(curDeskConfig.table_ceo_limit))
            self:SetText(deskHaveGO,"desc/ceoLvNeed/deskName",tableDes)
            local ceoID = furSaveData.ceoID
            if ceoID then
                local ceoLevel = CEODataManager:GetCEOLevel(ceoID)
                if ceoLevel>curDeskConfig.table_ceo_limit then
                    needShowDeskArrow = true
                end
            end
        end
    end

    self:GetGo(go,"ceoDesk/btnPanel/hireBtn/arr"):SetActive(needShowDeskArrow)

    local deskLevelMaxGO = self:GetGo(go,"ceoDesk/btnPanel/max")
    local deskUpgradeBtn = self:GetComp(go,"ceoDesk/btnPanel/hireBtn","Button")
    if nextDeskConfig then
        deskLevelMaxGO:SetActive(false)
        deskUpgradeBtn.gameObject:SetActive(true)
        deskUpgradeBtn.interactable = ResourceManger:GetDiamond() >= nextDeskConfig.table_cost
        self:SetText(go,"ceoDesk/btnPanel/hireBtn/num",tostring(nextDeskConfig.table_cost))
        self:SetText(go,"ceoDesk/btnPanel/star/icon/num",tostring(nextDeskConfig.table_reward))

        self:GetGo(go,"ceoDesk/btnPanel/hireBtn/buy"):SetActive(not haveDesk)
        self:GetGo(go,"ceoDesk/btnPanel/hireBtn/upgrade"):SetActive(haveDesk)
    else
        deskLevelMaxGO:SetActive(true)
        deskUpgradeBtn.gameObject:SetActive(false)
    end

    local upgradeDeskFunction = function()
        if nextDeskConfig then
            local cost = nextDeskConfig.table_cost
            ResourceManger:SpendDiamond(cost,ResourceManger.EVENT_UPGRADE_CEO_DESK,function(success)
                if success then
                    GameSDKs:TrackForeign("virtual_currency", {currency_type = 1, pos = "ceo工位升级", behaviour = 2, num_new = tonumber(cost)})
                    CEODataManager:UpgradeCEODesk(roomIndex)
                    local scene = FloorMode:GetScene()
                    local roomID = FloorMode:GetRoomIdByRoomIndex(roomIndex)
                    local roomRootData = scene:GetRoomRootGoData(roomID)
                    scene:InitCEOFurniture(roomRootData)
                    local deskLvl = nextDeskConfig.table_level
                    GameSDKs:TrackForeign("ceo_workspace", {roomid = roomID, countryid = GameTableDefine.CountryMode:GetCurrCountry(), level = deskLvl})
                    if not go:IsNull() then
                        self:InitRoomInfo(roomIndex,go)
                        self:InitCEOInfo(roomIndex,go)
                        self:InitDeskInfo(roomIndex,go)

                        local ceoID = furSaveData.ceoID
                        if ceoID then
                            local ceoLevel = CEODataManager:GetCEOLevel(ceoID)
                            local furLevel = furSaveData.level
                            local preDeskConfig = ConfigMgr.config_ceo_furniture_level[furLevel-1]
                            local curDeskConfig = ConfigMgr.config_ceo_furniture_level[furLevel]
                            if preDeskConfig and curDeskConfig and preDeskConfig.table_ceo_limit<ceoLevel and curDeskConfig.table_ceo_limit>=ceoLevel then
                                self:GetGo(go,"roomAndBuff/buff/have/shine"):SetActive(true)
                            end
                        end
                    end
                end
            end)
        end
    end

    self:SetButtonClickHandler(deskUpgradeBtn,upgradeDeskFunction)
end

function CEIInfoUIView:OnExit(view)
    self.super:OnExit(self)
    if self.closeCB then
        self.closeCB()
        self.closeCB = nil
    end
end

return CEIInfoUIView